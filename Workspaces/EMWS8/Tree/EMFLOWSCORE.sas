****************************************************************;
******             DECISION TREE SCORING CODE             ******;
****************************************************************;

******         LENGTHS OF NEW CHARACTER VARIABLES         ******;
LENGTH F_DepVar  $   12;
LENGTH I_DepVar  $   12;
LENGTH _WARN_  $    4;

******              LABELS FOR NEW VARIABLES              ******;
LABEL _NODE_  = 'Node' ;
LABEL _LEAF_  = 'Leaf' ;
LABEL P_DepVar0  = 'Predicted: DepVar=0' ;
LABEL P_DepVar1  = 'Predicted: DepVar=1' ;
LABEL Q_DepVar0  = 'Unadjusted P: DepVar=0' ;
LABEL Q_DepVar1  = 'Unadjusted P: DepVar=1' ;
LABEL V_DepVar0  = 'Validated: DepVar=0' ;
LABEL V_DepVar1  = 'Validated: DepVar=1' ;
LABEL R_DepVar0  = 'Residual: DepVar=0' ;
LABEL R_DepVar1  = 'Residual: DepVar=1' ;
LABEL F_DepVar  = 'From: DepVar' ;
LABEL I_DepVar  = 'Into: DepVar' ;
LABEL U_DepVar  = 'Unnormalized Into: DepVar' ;
LABEL _WARN_  = 'Warnings' ;


******      TEMPORARY VARIABLES FOR FORMATTED VALUES      ******;
LENGTH _ARBFMT_12 $     12; DROP _ARBFMT_12;
_ARBFMT_12 = ' '; /* Initialize to avoid warning. */
LENGTH _ARBFMT_8 $      8; DROP _ARBFMT_8;
_ARBFMT_8 = ' '; /* Initialize to avoid warning. */


_ARBFMT_12 = PUT( DepVar , BEST.);
 %DMNORMCP( _ARBFMT_12, F_DepVar );

******             ASSIGN OBSERVATION TO NODE             ******;
IF  NOT MISSING(AcceptedCmpTotal ) AND
                   0.5 <= AcceptedCmpTotal  THEN DO;
  IF  NOT MISSING(Recency ) AND
    Recency  <                 38.5 THEN DO;
    IF  NOT MISSING(AcceptedCmpTotal ) AND
                       1.5 <= AcceptedCmpTotal  THEN DO;
      _NODE_  =                   13;
      _LEAF_  =                   14;
      P_DepVar0  =     0.05263157894736;
      P_DepVar1  =     0.94736842105263;
      Q_DepVar0  =     0.05263157894736;
      Q_DepVar1  =     0.94736842105263;
      V_DepVar0  =                    0;
      V_DepVar1  =                    1;
      I_DepVar  = '1' ;
      U_DepVar  =                    1;
      END;
    ELSE DO;
      _ARBFMT_8 = PUT( Marital_Status , $8.);
       %DMNORMIP( _ARBFMT_8);
      IF _ARBFMT_8 IN ('WIDOW' ,'DIVORCED' ,'SINGLE' ) THEN DO;
        _NODE_  =                   23;
        _LEAF_  =                   13;
        P_DepVar0  =      0.2258064516129;
        P_DepVar1  =     0.77419354838709;
        Q_DepVar0  =      0.2258064516129;
        Q_DepVar1  =     0.77419354838709;
        V_DepVar0  =     0.41935483870967;
        V_DepVar1  =     0.58064516129032;
        I_DepVar  = '1' ;
        U_DepVar  =                    1;
        END;
      ELSE DO;
        IF  NOT MISSING(NumStorePurchases ) AND
          NumStorePurchases  <                  6.5 THEN DO;
          IF  NOT MISSING(NumWebVisitsMonth ) AND
            NumWebVisitsMonth  <                  5.5 THEN DO;
            _NODE_  =                   56;
            _LEAF_  =                   10;
            P_DepVar0  =     0.61111111111111;
            P_DepVar1  =     0.38888888888888;
            Q_DepVar0  =     0.61111111111111;
            Q_DepVar1  =     0.38888888888888;
            V_DepVar0  =     0.66666666666666;
            V_DepVar1  =     0.33333333333333;
            I_DepVar  = '0' ;
            U_DepVar  =                    0;
            END;
          ELSE DO;
            _NODE_  =                   57;
            _LEAF_  =                   11;
            P_DepVar0  =     0.14285714285714;
            P_DepVar1  =     0.85714285714285;
            Q_DepVar0  =     0.14285714285714;
            Q_DepVar1  =     0.85714285714285;
            V_DepVar0  =      0.3076923076923;
            V_DepVar1  =     0.69230769230769;
            I_DepVar  = '1' ;
            U_DepVar  =                    1;
            END;
          END;
        ELSE DO;
          _NODE_  =                   41;
          _LEAF_  =                   12;
          P_DepVar0  =     0.74545454545454;
          P_DepVar1  =     0.25454545454545;
          Q_DepVar0  =     0.74545454545454;
          Q_DepVar1  =     0.25454545454545;
          V_DepVar0  =     0.66666666666666;
          V_DepVar1  =     0.33333333333333;
          I_DepVar  = '0' ;
          U_DepVar  =                    0;
          END;
        END;
      END;
    END;
  ELSE DO;
    IF  NOT MISSING(AcceptedCmpTotal ) AND
                       2.5 <= AcceptedCmpTotal  THEN DO;
      _NODE_  =                   15;
      _LEAF_  =                   16;
      P_DepVar0  =      0.3103448275862;
      P_DepVar1  =     0.68965517241379;
      Q_DepVar0  =      0.3103448275862;
      Q_DepVar1  =     0.68965517241379;
      V_DepVar0  =     0.33333333333333;
      V_DepVar1  =     0.66666666666666;
      I_DepVar  = '1' ;
      U_DepVar  =                    1;
      END;
    ELSE DO;
      _NODE_  =                   14;
      _LEAF_  =                   15;
      P_DepVar0  =     0.82562277580071;
      P_DepVar1  =     0.17437722419928;
      Q_DepVar0  =     0.82562277580071;
      Q_DepVar1  =     0.17437722419928;
      V_DepVar0  =     0.81818181818181;
      V_DepVar1  =     0.18181818181818;
      I_DepVar  = '0' ;
      U_DepVar  =                    0;
      END;
    END;
  END;
ELSE DO;
  IF  NOT MISSING(Recency ) AND
    Recency  <                 32.5 THEN DO;
    IF  NOT MISSING(NumCatalogPurchases ) AND
                       5.5 <= NumCatalogPurchases  THEN DO;
      IF  NOT MISSING(NumStorePurchases ) AND
                         7.5 <= NumStorePurchases  THEN DO;
        IF  NOT MISSING(RFMstat ) AND
              1964.32692307692 <= RFMstat  THEN DO;
          _NODE_  =                   37;
          _LEAF_  =                    8;
          P_DepVar0  =     0.42857142857142;
          P_DepVar1  =     0.57142857142857;
          Q_DepVar0  =     0.42857142857142;
          Q_DepVar1  =     0.57142857142857;
          V_DepVar0  =     0.44444444444444;
          V_DepVar1  =     0.55555555555555;
          I_DepVar  = '1' ;
          U_DepVar  =                    1;
          END;
        ELSE DO;
          _NODE_  =                   36;
          _LEAF_  =                    7;
          P_DepVar0  =                    1;
          P_DepVar1  =                    0;
          Q_DepVar0  =                    1;
          Q_DepVar1  =                    0;
          V_DepVar0  =     0.69230769230769;
          V_DepVar1  =      0.3076923076923;
          I_DepVar  = '0' ;
          U_DepVar  =                    0;
          END;
        END;
      ELSE DO;
        IF  NOT MISSING(MntFishProducts ) AND
          MntFishProducts  <                   26 THEN DO;
          _NODE_  =                   34;
          _LEAF_  =                    5;
          P_DepVar0  =     0.71428571428571;
          P_DepVar1  =     0.28571428571428;
          Q_DepVar0  =     0.71428571428571;
          Q_DepVar1  =     0.28571428571428;
          V_DepVar0  =                  0.8;
          V_DepVar1  =                  0.2;
          I_DepVar  = '0' ;
          U_DepVar  =                    0;
          END;
        ELSE DO;
          _NODE_  =                   35;
          _LEAF_  =                    6;
          P_DepVar0  =     0.13793103448275;
          P_DepVar1  =     0.86206896551724;
          Q_DepVar0  =     0.13793103448275;
          Q_DepVar1  =     0.86206896551724;
          V_DepVar0  =     0.14285714285714;
          V_DepVar1  =     0.85714285714285;
          I_DepVar  = '1' ;
          U_DepVar  =                    1;
          END;
        END;
      END;
    ELSE DO;
      IF  NOT MISSING(NumWebVisitsMonth ) AND
                         7.5 <= NumWebVisitsMonth  THEN DO;
        IF  NOT MISSING(NumCatalogPurchases ) AND
                           0.5 <= NumCatalogPurchases  THEN DO;
          IF  NOT MISSING(Kidhome ) AND
            Kidhome  <                  0.5 THEN DO;
            _NODE_  =                   52;
            _LEAF_  =                    3;
            P_DepVar0  =     0.66666666666666;
            P_DepVar1  =     0.33333333333333;
            Q_DepVar0  =     0.66666666666666;
            Q_DepVar1  =     0.33333333333333;
            V_DepVar0  =                  0.6;
            V_DepVar1  =                  0.4;
            I_DepVar  = '0' ;
            U_DepVar  =                    0;
            END;
          ELSE DO;
            _NODE_  =                   53;
            _LEAF_  =                    4;
            P_DepVar0  =     0.26470588235294;
            P_DepVar1  =     0.73529411764705;
            Q_DepVar0  =     0.26470588235294;
            Q_DepVar1  =     0.73529411764705;
            V_DepVar0  =     0.21428571428571;
            V_DepVar1  =     0.78571428571428;
            I_DepVar  = '1' ;
            U_DepVar  =                    1;
            END;
          END;
        ELSE DO;
          _NODE_  =                   32;
          _LEAF_  =                    2;
          P_DepVar0  =     0.81428571428571;
          P_DepVar1  =     0.18571428571428;
          Q_DepVar0  =     0.81428571428571;
          Q_DepVar1  =     0.18571428571428;
          V_DepVar0  =     0.71428571428571;
          V_DepVar1  =     0.28571428571428;
          I_DepVar  = '0' ;
          U_DepVar  =                    0;
          END;
        END;
      ELSE DO;
        _NODE_  =                   16;
        _LEAF_  =                    1;
        P_DepVar0  =     0.90114942528735;
        P_DepVar1  =     0.09885057471264;
        Q_DepVar0  =     0.90114942528735;
        Q_DepVar1  =     0.09885057471264;
        V_DepVar0  =      0.8848167539267;
        V_DepVar1  =     0.11518324607329;
        I_DepVar  = '0' ;
        U_DepVar  =                    0;
        END;
      END;
    END;
  ELSE DO;
    _NODE_  =                    5;
    _LEAF_  =                    9;
    P_DepVar0  =     0.98042414355628;
    P_DepVar1  =     0.01957585644371;
    Q_DepVar0  =     0.98042414355628;
    Q_DepVar1  =     0.01957585644371;
    V_DepVar0  =     0.98795180722891;
    V_DepVar1  =     0.01204819277108;
    I_DepVar  = '0' ;
    U_DepVar  =                    0;
    END;
  END;

*****  RESIDUALS R_ *************;
IF  F_DepVar  NE '0'
AND F_DepVar  NE '1'  THEN DO;
        R_DepVar0  = .;
        R_DepVar1  = .;
 END;
 ELSE DO;
       R_DepVar0  =  -P_DepVar0 ;
       R_DepVar1  =  -P_DepVar1 ;
       SELECT( F_DepVar  );
          WHEN( '0'  ) R_DepVar0  = R_DepVar0  +1;
          WHEN( '1'  ) R_DepVar1  = R_DepVar1  +1;
       END;
 END;

****************************************************************;
******          END OF DECISION TREE SCORING CODE         ******;
****************************************************************;
drop _LEAF_;
