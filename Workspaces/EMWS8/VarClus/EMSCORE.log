MPRINT(EM_DIAGRAM):    data _null_;
MPRINT(EM_DIAGRAM):   call symput('NLDATE', strip(put(date(), NLDATE.)));
MPRINT(EM_DIAGRAM):   call symput('NLTIME', strip(put(datetime(), NLTIME.)));
MPRINT(EM_DIAGRAM):   run;
MPRINT(EM_DIAGRAM):   data _null_;
MPRINT(EM_DIAGRAM):   nldate= sasmsg("sashelp.dmine", "log_date_note", 'N', "16. April 2016" );
MPRINT(EM_DIAGRAM):   nltime= sasmsg("sashelp.dmine", "log_time_note", 'N', "18.29 Uhr" );
MPRINT(EM_DIAGRAM):   put "*------------------------------------------------------------*";
MPRINT(EM_DIAGRAM):   put "* Score Log";
MPRINT(EM_DIAGRAM):   put nldate;
MPRINT(EM_DIAGRAM):   put nltime;
MPRINT(EM_DIAGRAM):   put "*------------------------------------------------------------*";
MPRINT(EM_DIAGRAM):   run;
*------------------------------------------------------------*
* Score Log
Date:                16. April 2016
Time:                18.29 Uhr
*------------------------------------------------------------*
MPRINT(EM_DIAGRAM):    filename O3MFNTG0 "C:\\predictive-models-project\Workspaces\EMWS8\VarClus\EMSCORE.out" encoding="UTF-8" NOBOM;
MPRINT(EM_DIAGRAM):   proc printto print=O3MFNTG0 new;
MPRINT(EM_DIAGRAM):   run;
50802      %let EMEXCEPTIONSTRING=;
50803      *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):    *------------------------------------------------------------*;
50804      * SCORE: VarClus;
MPRINT(EM_DIAGRAM):   * SCORE: VarClus;
50805      *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;
50806      %let EM_ACTION = SCORE;
50807      %let syscc = 0;
50808      
50809      %macro main;
50810      
50811         filename temp catalog 'sashelp.emexpl.variableclustering_macros.source';
50812         %include temp;
50813         filename temp catalog 'sashelp.emexpl.variableclustering_macros2.source';
50814         %include temp;
50815         filename temp;
50816      
50817        %SetProperties;
50818      
50819         %if %upcase(&EM_ACTION) = CREATE %then %do;
50820             filename temp catalog 'sashelp.emexpl.variableclustering_create.source';
50821             %include temp;
50822             filename temp;
50823             %create;
50824         %end;
50825         %else
50826         %if %upcase(&EM_ACTION) = TRAIN %then %do;
50827              filename temp catalog 'sashelp.emexpl.variableclustering_train.source';
50828                 %include temp;
50829                 filename temp;
50830                 %train;
50831         %end;
50832         %else
50833         %if %upcase(&EM_ACTION) = SCORE %then %do;
50834                 filename temp catalog 'sashelp.emexpl.variableclustering_score.source';
50835                 %include temp;
50836                 filename temp;
50837                 %score;
50838         %end;
50839         %else
50840         %if %upcase(&EM_ACTION) = REPORT %then %do;
50841                 filename temp catalog 'sashelp.emexpl.variableclustering_report.source';
50842                 %include temp;
50843                 filename temp;
50844                 %report;
50845         %end;
50846         /*
50847         %if %upcase(&EM_ACTION) = OPENTESTTABLE %then %do;
50848             %put 'OPENING TABLE';
50849         %end;
50850         %if %upcase(&EM_ACTION) = CLOSETESTTABLE %then %do;
50851             %put 'CLOSE TABLE';
50852         %end;
50853         */
50854      %mend main;
50855      %main;
MPRINT(EM_DIAGRAM):    
MPRINT(MAIN):   filename temp catalog 'sashelp.emexpl.variableclustering_macros.source';
NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMEXPL.VARIABLECLUSTERING_MACROS.SOURCE.
50857     +/* Initialize property macro variables */
50858     +%macro SetProperties;
50859     +   %em_checkmacro(name=EM_PROPERTY_MAXCLUS,       global=Y, value=DEFAULT);
50860     +   %em_checkmacro(name=EM_PROPERTY_HIDEVARIABLE,  global=Y, value=Y);
50861     +   %em_checkmacro(name=EM_PROPERTY_PRINTOPTION,   global=Y, value=SHORT);
50862     +   %em_checkmacro(name=EM_PROPERTY_CLUSSOURCE,    global=Y, value=CORR);
50863     +   %em_checkmacro(name=EM_PROPERTY_CLUSCOMP,      global=Y, value=PRINCIPAL);
50864     +   %em_checkmacro(name=EM_PROPERTY_CLUSHIERACHY,      global=Y, value=Y);
50865     +   %em_checkmacro(name=EM_PROPERTY_INCLUDECLASSVAR,      global=Y, value=N);
50866     +   %em_checkmacro(name=EM_PROPERTY_EXPORTEDCOMP,      global=Y, value=CLUSTERCOMP);
50867     +   %em_checkmacro(name=EM_PROPERTY_MAXEIGEN,         global=Y, value=DEFAULT);
50868     +   %em_checkmacro(name=EM_PROPERTY_PROPORTION,      global=Y, value=DEFAULT);
50869     +   %em_checkmacro(name=EM_PROPERTY_PRINTOPTION,      global=Y, value=SHORT);
50870     +   %em_checkmacro(name=EM_PROPERTY_TWOSTAGECLUS,      global=Y, value=AUTO);
50871     +   %em_checkmacro(name=EM_PROPERTY_SUPPRESSSAMPWARN,      global=Y, value=N);
50873     +%mend SetProperties;
50875     +%Macro MakeDummyVariables(indata=,
50876     +                          outvar=,
50877     +                          outdata=,
50878     +                          fileref=,
50879     +                          recreatecmeta=N, /* optional */
50880     +                          incmeta=,     /* optional */
50881     +                          outcmeta=,    /* optional */
50882     +                          ndummyvars=_ndummyvars
50883     +                          );
50884     +    %global &ndummyvars;
50886     +    proc dmdb batch data=&indata out=_dmdbdat dmdbcat=_dmdbcat classout=_classout;;
50887     +       class
50888     +       %EM_BINARY_INPUT %EM_NOMINAL_INPUT %EM_ORDINAL_INPUT
50889     +       %EM_BINARY_REJECTED %EM_NOMINAL_REJECTED %EM_ORDINAL_REJECTED
50890     +    ;
50891     +    run;
50892     +    %let &ndummyvars = 0;
50893     +    data _null_;
50894     +    %let dsid = %sysfunc(open(work._classout));
50895     +      %let &ndummyvars = %sysfunc(attrn(&dsid, NOBS));
50896     +    %let dsid = %sysfunc(close(&dsid));
50897     +    run;
50899     +    proc dmzip data=_dmdbdat dmdbcat=_dmdbcat;
50900     +       input
50901     +       %EM_BINARY_INPUT %EM_NOMINAL_INPUT %EM_ORDINAL_INPUT
50902     +       %EM_BINARY_REJECTED %EM_NOMINAL_REJECTED %EM_ORDINAL_REJECTED
50903     +        / level=nominal stdize=no;
50904     +       make outvar = &outvar;
50905     +       score data = &indata out =&outdata;
50906     +       code  file=  "&fileref";
50907     +    run;
50908     +    %if &recreatecmeta eq Y %then %do;
50909     +    proc contents data =&outvar out=_tmpds(keep=NAME LABEL);
50910     +    data _tmpds;
50911     +        set _tmpds;
50912     +           ROLE = 'INPUT';
50913     +           LEVEL = 'INTERVAL';
50914     +           CREATOR='DMZIP';
50915     +           if NAME = '_TYPE_' then delete;
50916     +    run;
50917     +    data &outcmeta;
50918     +         set &incmeta _tmpds;
50919     +    run;
50920     +    %end;
50921     +    proc datasets lib=work nolist;
50922     +      delete  _dmdbdat _dmdbcat _classout
50923     +    %if &recreatecmeta eq Y %then %do;
50924     +    _tmpds
50925     +    %end;
50926     +    ;
50927     +    quit;
50928     +%Mend MakeDummyVariables;
50930     +/*--- Determine Optimal Number of Cluster ----
50931     +%macro FindClusNum(statds=, groupds=, minvariation=);
50932     +   %global optnclus;
50933     +   data varclus_tmp(drop=_NAME_);
50934     +      set &statDs;
50935     +      where _type_ ='PROPOR';
50936     +   run;
50937     +   proc sort data=varclus_tmp;
50938     +      by _NCL_;
50939     +   run;
50940     +   proc transpose data=varclus_tmp out=varclus_tmp;
50941     +      by _NCL_;
50942     +      var %EM_INTERVAL_INPUT
50943     +      %if &EM_PROPERTY_INCLUDECLASSVAR eq Y %then %do;
50944     +      %let dsid = %sysfunc(open(&EM_USER_OUTDUMMY));
50945     +      %let nvar = %sysfunc(attrn(&dsid, NVAR));
50946     +          %do i = 2 %to &nvar;
50947     +          %let varname = %sysfunc(varname(&dsid, &i));
50948     +          &varname
50949     +          %end;
50950     +      %end;
50951     +   ;
50952     +   run;
50954     +   %if &minVariation eq %then %do;
50955     +       %let minVariation = &EM_PROPERTY_MINVARIATION;
50956     +   %end;
50957     +   %if ^(0<&minVariation<100) %then %do;
50958     +       %let minVariation = 90;
50959     +   %end;
50961     +   data _null_;
50962     +      set varclus_tmp end=eof;
50963     +      by _NCL_;
50964     +      retain flag 0;
50965     +      if first._ncl_ then flag=0;
50966     +      if .<col1 < &minVariation then flag=1;
50967     +      if last._ncl_ and ^flag then do;
50968     +         call symput('OPTNCL', _ncl_);
50969     +         stop;
50970     +      end;
50971     +     if eof then call symput('OPTNCL', _ncl_);
50972     +   run;
50974     +   %let optnclus = &OPTNCL;
50976     +   data varclus_tmp(drop=_NCL_ _NAME_);
50977     +      set &statDs;
50978     +      where _type_ in('RSQUARED' 'GROUP') and _NCL_=&OPTNCL;
50979     +   run;
50980     +   proc sort data=varclus_tmp;
50981     +      by _TYPE_;
50982     +   run;
50983     +   proc transpose data=varclus_tmp out=varclus_tmp;
50984     +      by _TYPE_;
50985     +   run;
50986     +   proc sort data=varclus_tmp;
50987     +      by _name_ _type_;
50988     +   run;
50990     +  proc transpose data=varclus_tmp out=&groupds;
50991     +      by _NAME_;
50992     +   run;
50993     +   proc sort data=&groupDs(rename=(col1=Cluster col2=Rsquare _NAME_=VARIABLE));
50994     +      by Cluster descending Rsquare;
50995     +      where Cluster ne 0;
50996     +   run;
50997     +   proc datasets lib=work nolist mt=(DATA VIEW);
50998     +      delete varclus_tmp;
50999     +   run;
51000     +   quit;
51001     +%mend findClusNum;
51002     +*/
51004     +%macro getNclusfromTrain(inoutstat=, nc=);
51005     +%global &nc;
51006     +data _null_;
51007     +    set &inoutstat end=eof;
51008     +    if eof then do;
51009     +    call symput("&nc", _ncl_);
51010     +    end;
51011     +run;
51012     +%mend  getNclusfromTrain;
51014     +%macro MakeDeltaCode(groupds=, outstatscore=, deltacodefile=);
51016     +     *--- Build Code to Modify Metadata ---*;
51017     +     filename X "&deltacodefile";
51018     +     data _null_;
51019     +        FILE X;
51020     +        set &groupds end=eof;
51021     +        /*by Cluster;*/
51022     +         if _N_=1 then do;
51023     +           %if &EM_PROPERTY_INCLUDECLASSVAR eq Y %then %do;
51024     +            put "if upcase(strip(ROLE)) ='INPUT' and upcase(strip(LEVEL)) ^='INTERVAL' then ROLE ='REJECTED' ;";
51025     +           %end;
51026     +           put "if upcase(strip(ROLE))='INPUT' and upcase(strip(LEVEL))='INTERVAL' then do;";
51027     +           put "if upcase(strip(NAME)) in (";
51028     +        end;
51029     +        if Strip(upcase(Selected)) eq 'YES' then do;
51030     +           string = '"'!!trim(left(VARIABLE))!!'"';
51031     +           put string;
51032     +        end;
51033     +        if eof then do;
51034     +           put ') then ROLE="INPUT";';
51035     +           put 'else ROLE="REJECTED";';
51036     +           put 'end;';
51038     +           %if %upcase(&EM_PROPERTY_HIDEVARIABLE) eq Y %then %do;
51039     +             put 'if upcase(strip(ROLE)) = "REJECTED" then delete ;';
51040     +           %end;
51041     +        end;
51042     +     run;
51043     +     quit;
51045     +     filename X;
51047     +     quit;
51048     +%mend MakeDeltaCode;
51050     +%macro MakeVarClusCorrData(statds=, corrds=, corrplotds= );
51051     +    %if ^%sysfunc(exist(&statds)) %then %do;
51052     +         %goto doendc;
51053     +    %end;
51055     +    data &corrds(drop=_TYPE_ _NCL_) ;
51056     +       set &statds;
51057     +       where _type_ eq 'CORR' ;
51058     +    run ;
51059     +    proc sort data=&corrds;
51060     +       by _NAME_ ;
51061     +    run ;
51062     +    proc transpose data=&corrds out=&corrplotds name=_TMP_;
51063     +      BY _NAME_ ;
51064     +    run ;
51065     +    data &corrplotds;
51066     +       length _Y_ $100;
51067     +       set &corrplotDs;
51068     +       if _LABEL_ ne '' then _Y_=_LABEL_ ; else _Y_=_TMP_ ;
51069     +    run ;
51070     +    data varclus_match(rename=(_TMP_= _NAME_ _LABEL_=_X_));
51071     +       set &corrplotds;
51072     +       where _LABEL_ ne '' ;
51073     +       keep _TMP_ _LABEL_ ;
51074     +    run ;
51075     +    data _null_;
51076     +       nobs=0;
51077     +       dsid = open('varclus_match');
51078     +       if dsid then do;
51079     +          nobs = attrn(dsid, 'NOBS');
51080     +          dsid = close(dsid);
51081     +       end;
51082     +       call symput ('CORR_NOBS', nobs);
51083     +    run;
51084     +    %if &corr_nobs %then %do;
51085     +        proc sort data=varclus_match;
51086     +           by _name_;
51087     +        run ;
51088     +        proc sort data=&corrplotds;
51089     +           by _name_;
51090     +        run ;
51091     +        data &corrplotds(keep= _X_ _Y_ col1 rename=(col1=Correlation)) ;
51092     +           merge varclus_match &corrplotds;
51093     +           by _NAME_ ;
51094     +           if _X_ eq '' then _X_=_NAME_ ;
51095     +           label _X_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_variable, noquote))";
51096     +           label _Y_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_variable, noquote))";
51097     +           label col1 = "%sysfunc(sasmsg(sashelp.dmine, rpt_correlation_vlabel, noquote))";
51099     +       run ;
51100     +    %end;
51101     +    %else %do;
51102     +        proc sort data=&corrplotds;
51103     +           by _name_;
51104     +        run ;
51105     +        data &corrplotds(keep= _NAME_ _Y_ col1 rename=(_NAME_=_X_ col1=Correlation)) ;
51106     +           set &corrplotds;
51107     +           label _NAME_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_variable, noquote))" ;
51108     +           label _Y_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_variable, noquote))" ;
51109     +           label col1 = "%sysfunc(sasmsg(sashelp.dmine, rpt_correlation_vlabel, noquote))";
51111     +        run ;
51112     +    %end;
51113     +    proc sort data=&corrplotds;
51114     +       by _X_ _Y_;
51115     +    run ;
51116     +    proc datasets lib=work nolist mt=(DATA VIEW);
51117     +       delete varclus_match;
51118     +    run;
51119     +    quit;
51121     +%doendc:
51123     +%mend MakeVarClusCorrData;
51125     +%macro MakeStatPlotData(statds= , outstatplotds=);
51126     +   %if %sysfunc(exist(&statds)) %then %do;
51128     +       data varclus_tmp(drop=_NAME_ _NCL_) ;
51129     +          set &statDs;
51130     +          where _type_ in('MEAN', 'STD', 'N');
51131     +       run ;
51132     +       proc transpose data=varclus_tmp out=&outstatplotds;
51133     +          id _TYPE_ ;
51134     +       run ;
51135     +       data &outstatplotds;
51136     +          set &outstatplotds(obs=1000);
51137     +          label _name_= "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_name, noquote))";
51138     +          label _label_="%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_label, noquote))" ;
51139     +          if MEAN ne 0 then SCALEDSTD= STD / MEAN ;
51140     +          else SCALEDSTD= STD ;
51141     +          label SCALEDSTD = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_scaledstd, noquote))";
51142     +       run ;
51143     +       proc sort data=&outstatplotds;
51144     +          by descending SCALEDSTD ;
51145     +       run ;
51146     +       proc datasets lib=work nolist mt=(DATA VIEW);
51147     +          delete varclus_tmp;
51148     +       run;
51149     +       quit;
51150     +    %end;
51152     +%mend MakeStatPlotData;
51155     +%macro CreateScoreCode(indata=, ncluscomp=, fileref=);
51156     +     %EM_GETNAME(KEY=OUTSTATSCORE, type=DATA);
51157     +    data &EM_USER_OUTSTATSCORE;
51158     +          set &indata;
51159     +          if (_TYPE_ in ('SCORE' 'MEAN' 'STD') and _NCL_ = &ncluscomp ) or (_TYPE_ in ('MEAN' 'STD'));
51160     +          if _TYPE_ = 'MEAN' then _NAME_='MEAN';
51161     +          if _TYPE_ = 'STD' then _NAME_='STD';
51162     +          DROP _TYPE_ _NCL_;
51163     +     run;
51165     +     filename _file_  "&fileRef";
51167     +     data _null_;
51168     +        FILE _file_ MOD;
51169     +        put ' ';
51170     +        put '/*-------------------------------------------------*/';
51171     +        put '/* ' "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_score_title_begin , noquote))" '*/';
51172     +        put '/*-------------------------------------------------*/';
51173     +        put ' ';
51174     +        %let dsid = %sysfunc(open(&EM_USER_OUTSTATSCORE));
51176     +        %let nvar = %sysfunc(attrn(&dsid, NVAR));
51177     +        %let vn_name =%sysfunc(varnum(&dsid, _NAME_));
51179     +        %let k = 1;
51180     +        %do %while(^%sysfunc(fetch(&dsid)));
51181     +                %let _name = %sysfunc(getvarc(&dsid, &vn_name));
51182     +                %if &k > 2 %then %do;
51183     +                 %let cn = %eval(&k-2);
51184     +                 put "&_name = 0 ; /*---" "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_score_cluscompnum, noquote, &cn))"  "------ */";
51185     +                %end;
51186     +                %let k = %eval(&k+1);
51187     +        %end;
51189     +        %let rc = %sysfunc(rewind(&dsid));
51191     +        %do i= 2 %to &nvar;
51192     +            %let _varname =  %sysfunc(varname(&dsid, &i));
51193     +            %do %while(^%sysfunc(fetch(&dsid)));
51194     +                %let _name = %sysfunc(getvarc(&dsid, &vn_name));
51195     +                %if &_name = MEAN %then
51196     +                %let _mean = %sysfunc(getvarn(&dsid, &i));
51197     +                %else %if &_name = STD %then
51198     +                %let _std = %sysfunc(getvarn(&dsid, &i));
51199     +                %else %do;
51200     +                      %let coeff =  %sysfunc(getvarn(&dsid, &i));
51201     +                      %let abscoeff = %sysfunc(abs(&coeff));
51202     +                          %if &abscoeff >  0 %then %do;
51203     +                       put "&_name = &_name+&coeff * (&_varname - &_mean)/&_std;";
51204     +                           %end;
51205     +                 %end;
51206     +             %end;
51207     +             %let rc = %sysfunc(rewind(&dsid));
51208     +         %end;
51210     +        %let dsid= %sysfunc(close(&dsid));
51211     +       run;
51212     +%mend CreateScoreCode;
51216     +/*----------------------------------------------------------
51217     +    Instead of using %MakeRSquareData,
51218     +    %MakeVarClusResultTable at macro2.source is used
51219     + +----------------------------------------------------------*/
51222     +%macro MakeRSquareData(indata=, inClusRSquare=, outdata=, ncluster=);
51224     +/* modifying  from ods rsquare = data */
51226     +data &outdata(drop= ControlVar  NumberOfClusters CurrentCluster);
51227     +    Length Cluster $16;
51228     +    length Variable $32;
51229     +    Length VariableLabel $64;
51230     +    set &indata; retain CurrentCluster;
51231     +    if NumberOfClusters ^= &ncluster then delete;
51232     +    if strip(Cluster) eq '' then Cluster = CurrentCluster;
51233     +    CurrentCluster = Cluster;
51234     +   run;
51235     +proc sort data =&outdata ;
51236     +     by Cluster RsquareRatio;
51237     +run;
51238     +data _tmprsq(drop=index);
51239     +     set &outdata; by Cluster;
51240     +     if first.Cluster then do;
51241     +     index = strip(scan(Cluster,2 ));
51242     +     Variable = "Clus"||index;
51243     +     VariableLabel = "Cluster Component "||index;
51244     +     OwnCluster = 1;
51245     +     NextClosest = .;
51246     +     RsquareRatio = 0;
51247     +     output;
51248     +     end;
51249     +run;
51251     +proc sort data = _tmprsq ;
51252     +     by Cluster RsquareRatio;
51253     +run;
51254     +data &outdata;
51255     +     set &outdata _tmprsq;
51256     +by Cluster;
51257     +run;
51260     +/* Just create the Selected variable with all YES */
51262     +data &outdata;
51263     +    set &outdata; by cluster;
51264     +    length Selected $8;
51265     +    Selected = 'YES';
51266     +    label  OwnCluster = 'R-Sqaure with Cluster Component';
51267     +    label  NextClosest = 'R-Sqaure with Next Cluster Component';
51268     +    rename OwnCluster = RSqWithClusterComp;
51269     +    rename NextClosest = RSqWithNextClusComp;
51270     +run;
51273     +/* Selected = Y/N will be done %score section -----
51275     +%if &EM_PROPERTY_EXPORTEDCOMP ne CLUSTERCOMP %then %do;
51276     +data &outdata;
51277     +    set &outdata; by cluster;
51278     +    length Selected $8;
51279     +    if first.Cluster then Selected = 'YES';
51280     +    else Selected = 'NO';
51281     +    label  OwnCluster = 'R-Sqaure with Cluster Component';
51282     +    label  NextClosest = 'R-Sqaure with Next Cluster Component';
51283     +    rename OwnCluster = RSqWithClusterComp;
51284     +    rename NextClosest = RSqWithNextClusComp;
51285     +run;
51286     +%end;
51287     +%else %do;
51288     +data &outdata;
51289     +    set &outdata; by cluster;
51290     +    if last.Cluster then Selected = 'YES';
51291     +    else Selected = 'NO';
51292     +    label  OwnCluster = 'R-Sqaure with Cluster Component';
51293     +    label  NextClosest = 'R-Sqaure with Next Cluster Component';
51294     +    rename OwnCluster = RSqWithClusterComp;
51295     +    rename NextClosest = RSqWithNextClusComp;
51296     +run;
51297     +%end;
51298     +---------------------------------------------------------------*/
51300     +%if %sysfunc(exist(&inClusRSquare)) %then %do;
51301     +/* to calculate NextClosestClusRsq */
51302     +proc transpose data = &inClusRSquare  out=_clusRsq;
51303     +      by cluster;
51304     +      run;
51305     +data _clusRsq;
51306     +     set _clusRsq;
51307     +     if strip(upcase(Cluster)) eq strip(upcase(_NAME_)) then delete;
51308     +run;
51310     +proc sort data=_clusRsq;
51311     +    by cluster col1;
51312     +    run;
51313     +data _clusRsq(drop=_NAME_ _LABEL_);
51314     +     set _clusRsq; by cluster;
51315     +     if last.Cluster then output;
51316     +     label  COL1 = 'R-Sqaure with Next Cluster Component';
51317     +     rename COL1 = RSqWithNextClusComp;
51318     +     rename Cluster = Variable;
51319     +     label  Cluster = "Variable";
51320     +run;
51322     +proc sort data =&outdata;
51323     +     by Variable;
51324     +run;
51325     +data &outdata;
51326     +    merge &outdata _clusRsq;
51327     +    by Variable;
51328     +run;
51329     +proc sort data =&outdata;
51330     +by Cluster  RsquareRatio;
51331     +run;
51332     +quit;
51333     +%end;
51335     +proc datasets lib = work nolist;
51336     +     delete _tmprsq _clusRsq;
51337     +     run;
51338     +quit;
51340     +%mend MakeRSquareData;
51343     +/*-------------------------------------------------------------------------*/
51347     +%macro ModifyCorr(indata=,
51348     +                  outdata=,
51349     +                  rsquare = Y
51350     +                  );
51351     +    data corr_tmp;
51352     +        set &indata;
51353     +    run;
51354     +     proc sql;
51355     +           update &indata
51356     +           set
51357     +     %let dsid = %sysfunc(open(work.corr_tmp));
51358     +     %let nvar = %sysfunc(attrn(&dsid, NVAR));
51359     +          %do i = 4 %to &nvar;
51360     +          %let _name = %sysfunc(varname(&dsid, &i));
51361     +             %if &rsquare eq Y %then %let _name_md = &_name.**2;
51362     +            %else  %let _name_md = &_name;
51363     +            %if &i < &nvar %then %do;
51364     +               &_name = 1- &_name_md ,
51365     +            %end;
51366     +            %else %do;
51367     +               &_name = &_name_md where _TYPE_ contains 'CORR' ;
51368     +            %end;
51369     +          %end;
51370     +      %let dsid= %sysfunc(close(&dsid));
51372     +      select * from &indata;
51373     +      run;
51374     +      proc datasets lib = work nolist;
51375     +           delete corr_tmp;
51376     +      run;
51377     +      quit;
51379     + %mend ModifyCorr;
51381     + %macro MakeClusStructCorrData(indata=,outdata=, ncluster=, Rsquare=N);
51382     +    data &outdata(drop= _NCL_  _TYPE_);
51383     +       set &indata;
51384     +       if ^(strip(_NCL_) eq &ncluster and strip(_TYPE_) eq 'STRUCTUR') then delete;
51385     +       rename _NAME_ = Cluster;
51386     +       label _NAME_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_clustername,  noquote))";
51387     +    run;
51388     +    %if &RSquare eq Y %then %do;
51389     +     data corr_tmp;
51390     +        set &outdata;
51391     +     run;
51393     +     data &outdata(drop=i);
51394     +          set &outdata;
51395     +          %let dsid = %sysfunc(open(work.corr_tmp));
51396     +          %let nvar = %sysfunc(attrn(&dsid, NVAR));
51397     +          %do i = 2 %to &nvar;
51398     +            %let _name = %sysfunc(varname(&dsid, &i));
51399     +            %let _name_md = &_name.**2;
51400     +                &_name = &_name_md;
51401     +          %end;
51402     +      %let dsid= %sysfunc(close(&dsid));
51403     +      run;
51404     +      proc datasets lib = work nolist;
51405     +           delete corr_tmp;
51406     +      run;
51408     +    %end;
51409     +     quit;
51410     +%mend MakeClusStructCorrData;
51412     +%macro MakeInterClusCorrData(indata=, outdata=, ncluster=, RSquare=N, makeplotds=N, plotds=);
51413     +    data &outdata(drop= _NCL_  _TYPE_);
51414     +       set &indata;
51415     +       if ^(strip(_NCL_) eq &ncluster and strip(_TYPE_) eq 'CCORR') then delete;
51416     +       rename _NAME_ = Cluster;
51417     +       label _NAME_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_clustername,  noquote))";
51418     +    run;
51419     +    data corr_tmp;
51420     +        set &outdata;
51421     +    run;
51423     +    %let dsid = %sysfunc(open(work.corr_tmp));
51424     +    %let nclus2= %eval(&ncluster+1);
51425     +    data &outdata;
51426     +         set &outdata;
51427     +          %do i = 2 %to &nclus2;
51428     +          %let i_1 = %eval(&i-1);
51429     +            %let _name = %sysfunc(varname(&dsid, &i));
51430     +            %let _newName = Clus&i_1;
51431     +                rename &_name = &_newName; ;
51432     +                *label &_name ="Cluster &i_1";
51433     +                label &_name = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_clusternum, noquote,  &i_1))";
51434     +          %end;
51435     +          keep Cluster
51436     +          %do i = 2 %to &nclus2;
51437     +                %let _name = %sysfunc(varname(&dsid, &i));
51438     +                &_name
51439     +          %end;
51440     +          ;
51441     +    %let dsid= %sysfunc(close(&dsid));
51442     +     run;
51443     +     quit;
51445     +    %if &RSquare eq Y %then %do;
51447     +       data corr_tmp;
51448     +        set &outdata;
51449     +     run;
51451     +     data &outdata(drop=i);
51452     +          set &outdata;
51453     +          %let dsid = %sysfunc(open(work.corr_tmp));
51454     +          %let nvar = %sysfunc(attrn(&dsid, NVAR));
51455     +          %do i = 2 %to &nvar;
51456     +            %let _name = %sysfunc(varname(&dsid, &i));
51457     +            %let _name_md = &_name.**2;
51458     +                &_name = &_name_md;
51459     +          %end;
51460     +      %let dsid= %sysfunc(close(&dsid));
51461     +      run;
51462     +    %end;
51464     +    %if &makeplotds eq Y %then %do;
51465     +     proc transpose data = &outdata
51466     +          out=&plotds(drop=_LABEL_ rename=(_NAME_ = Y Cluster=X Col1= Correlation));
51467     +          by cluster;
51468     +     run;
51469     +     data &plotds;
51470     +          set  &plotds;
51471     +          label x="%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_cluster, noquote))";
51472     +          label Y="%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_cluster, noquote))";
51473     +     run;
51474     +     %end;
51475     +     proc datasets lib = work nolist;
51476     +           delete corr_tmp;
51477     +     run;
51478     +     quit;
51479     +%mend MakeInterClusCorrData;
51482     +%macro MakeClusConstellData(indata=, outlink=, outnode=);
51484     +data &outlink(drop = Selected);
51485     +     set &indata;
51486     +     LINKID = _N_;
51487     +     label LINKID = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_linkid,  noquote))";
51488     +     if strip(upcase(Cluster)) eq strip(upcase(Variable)) then Variable = ClosestCluster;
51489     +run;
51490     +data &outnode(keep=NODEID TYPE LABEL);
51491     +    set &indata;
51492     +    length TYPE $16;
51493     +    rename Variable = NODEID;
51494     +    label  Variable= "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nodeidvar, noquote))";
51495     +    if strip(upcase(Cluster)) eq strip(upcase(Variable))
51496     +    then  TYPE = "CLUSTER";
51497     +    else  TYPE="VARIABLE";
51498     +    label TYPE = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nodetype, noquote))";
51499     +run;
51500     +quit;
51501     +%mend MakeClusConstellData;
51505     +%macro MakeClusConstellData(indata=, outlink=, outnode=);
51507     +data &outlink(drop = Selected);
51508     +     set &indata;
51509     +     LINKID = _N_;
51510     +     label LINKID = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_linkid,  noquote))";
51511     +     if strip(upcase(Cluster)) eq strip(upcase(Variable)) then Variable = ClosestCluster;
51512     +run;
51513     +data &outnode(keep=NODEID TYPE LABEL);
51514     +    set &indata;
51515     +    length TYPE $16;
51516     +    rename Variable = NODEID;
51517     +    label  Variable= "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nodeidvar, noquote))";
51518     +    if strip(upcase(Cluster)) eq strip(upcase(Variable))
51519     +    then  TYPE = "CLUSTER";
51520     +    else  TYPE="VARIABLE";
51521     +    label TYPE = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nodetype, noquote))";
51522     +run;
51523     +quit;
51524     +%mend MakeClusConstellData;
51527     +/*--- This will work only when inds is not a view data -------
51529     +%macro getNVarNObs(inds=, nvar=, nobs=);
51531     +    %global &nvar;
51532     +    %global &nobs;
51533     +    data _null_;
51534     +         dsid = open("&inds");
51535     +         nv = attrn(dsid, 'NVAR');
51536     +         no = attrn(dsid, 'NOBS');
51537     +         dsid = close(dsid);
51538     +         call symput("&nvar", nv);
51539     +         call symput("&nobs", no);
51540     +    run;
51541     +    quit;
51542     +%mend  getNVarNObs;
51544     ++---------------------------------------------------------------*/
51547     +%macro getNVar(inds=, nvar=);
51548     +    %global &nvar;
51549     +    data _null_;
51550     +         dsid = open("&inds");
51551     +         nv = attrn(dsid, 'NVAR');
51552     +         dsid = close(dsid);
51553     +         call symput("&nvar", nv);
51554     +    run;
51555     +    quit;
51556     +%mend  getNVar;
51560     +%macro getNObs(inds=, nobs=);
51561     +    %global &nobs;
51562     +    data _null_;
51563     +        set &inds end=eof;
51564     +        if eof then call symput("&nobs", _N_);
51565     +    run;
51566     +    quit;
51567     +%mend  getNObs;
51569     +%Macro CreateVarclusMeta(trainnum=);
51570     +   %EM_GETNAME(KEY=VARCLUSMETA, TYPE=DATA);
51571     +    data &EM_USER_VARCLUSMETA;
51572     +         length TrainNum 8.;
51573     +         length NewTrain $8;
51574     +         length NGCluster 8.;
51575     +         length ExportedComp $16;
51576     +         length HideVariable $8;
51577     +         TrainNum = &trainnum;
51578     +         NewTrain = "Y";
51579     +         ExportedComp = "&EM_PROPERTY_EXPORTEDCOMP";
51580     +         HideVariable = "&EM_PROPERTY_HIDEVARIABLE";
51581     +         NGCluster = 0; /* zero means no twostage */
51582     +   run;
51583     +   quit;
51584     +%mend CreateVarclusMeta;
NOTE: %INCLUDE (level 1) ending.
MPRINT(MAIN):   filename temp catalog 'sashelp.emexpl.variableclustering_macros2.source';
NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMEXPL.VARIABLECLUSTERING_MACROS2.SOURCE.
51586     +%macro MakeInterClusCorrData(indata=, outdata=, ncluster=, globalclusid=, RSquare=N, makeplotds=N, plotds=);
51587     +    data &outdata(drop= _NCL_  _TYPE_);
51588     +       set &indata;
51589     +       if ^(strip(_NCL_) eq &ncluster and strip(_TYPE_) eq 'CCORR') then delete;
51590     +       %if &globalclusid ne %then %do;
51591     +       _NAME_ = "GC&globalclusid._"||upcase(_NAME_);
51592     +       rename _NAME_ = Cluster;
51593     +       %end;
51594     +       %else %do;
51595     +        _NAME_ = upcase(_NAME_);
51596     +       rename _NAME_ = Cluster;
51597     +       %end;
51598     +       label _NAME_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_clustername,  noquote))";
51599     +    run;
51600     +    data corr_tmp;
51601     +        set &outdata;
51602     +    run;
51604     +    %let dsid = %sysfunc(open(work.corr_tmp));
51605     +    %let nclus2= %eval(&ncluster+1);
51606     +    data &outdata;
51607     +         set &outdata;
51608     +          %do i = 2 %to &nclus2;
51609     +          %let i_1 = %eval(&i-1);
51610     +            %let _name = %sysfunc(varname(&dsid, &i));
51611     +            %if &globalclusid ne %then
51612     +                %do; %let _newName = GC&globalclusid._CLUS&i_1;
51613     +                     rename &_name = &_newName;
51614     +                     *label &_name ="GC &globalclusid : Cluster &i_1";
51615     +                     label &_name = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_gc_clusternum, noquote,  &globalclusid, &i_1))";
51616     +                %end;
51617     +            %else
51618     +                %do; %let _newName = CLUS&i_1;
51619     +                     rename &_name = &_newName;
51620     +                     *label &_name ="Cluster &i_1";
51621     +                     label &_name = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_clusternum, noquote,  &i_1))";
51622     +                %end;
51623     +          %end;
51624     +          keep Cluster
51625     +          %do i = 2 %to &nclus2;
51626     +                %let _name = %sysfunc(varname(&dsid, &i));
51627     +                &_name
51628     +          %end;
51629     +          ;
51630     +    %let dsid= %sysfunc(close(&dsid));
51631     +     run;
51632     +     quit;
51634     +    %if &RSquare eq Y %then %do;
51636     +       data corr_tmp;
51637     +        set &outdata;
51638     +     run;
51640     +     data &outdata;
51641     +          set &outdata;
51642     +          %let dsid = %sysfunc(open(work.corr_tmp));
51643     +          %let nvar = %sysfunc(attrn(&dsid, NVAR));
51644     +          %do i = 2 %to &nvar;
51645     +            %let _name = %sysfunc(varname(&dsid, &i));
51646     +            %let _name_md = &_name.**2;
51647     +                &_name = &_name_md;
51648     +          %end;
51649     +      %let dsid= %sysfunc(close(&dsid));
51650     +      run;
51651     +    %end;
51653     +    %if &makeplotds eq Y %then %do;
51654     +     proc transpose data = &outdata
51655     +          out=&plotds(drop=_LABEL_ rename=(_NAME_ = Y Cluster=X Col1= Correlation));
51656     +          by cluster;
51657     +     run;
51658     +     data &plotds;
51659     +          set  &plotds;
51660     +          label x="%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_cluster, noquote))";
51661     +          label Y="%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_cluster, noquote))";
51662     +          label  Correlation="%sysfunc(sasmsg(sashelp.dmine, rpt_correlation_vlabel, noquote))";
51663     +     run;
51664     +     %end;
51665     +     proc datasets lib = work nolist;
51666     +           delete corr_tmp;
51667     +     run;
51668     +     quit;
51669     +%mend MakeInterClusCorrData;
51671     +%macro MakeOwnRSquare(indata=, outdata=, ncluster=, globalclusid=);
51672     +    data _tmpds(drop= _NCL_);
51673     +       set &indata;
51674     +       if ^(strip(_NCL_) eq &ncluster and strip(_TYPE_) in ('GROUP','RSQUARED')) then delete;
51675     +       %if &globalclusid ne %then %do;
51676     +           _NAME_ = "GC&globalclusid.";
51677     +       rename _NAME_ = Cluster;
51678     +       %end;
51679     +       %else %do;
51680     +        _NAME_ = "CLUS";
51681     +        rename _NAME_ = Cluster;
51682     +       %end;
51683     +       label _NAME_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_clustername,  noquote))";
51684     +    run;
51685     +    proc transpose data =_tmpds out =&outdata;
51686     +    run;
51688     +    data &outdata(drop=COL1);
51689     +        %if &globalclusid ne %then %do;
51690     +        length GCluster $16;
51691     +        %end;
51692     +        length Cluster $32;
51693     +        length _NAME_ $32;
51694     +         set &outdata;
51695     +         _NAME_ = upcase(_NAME_);
51696     +         rename _NAME_=Variable;
51697     +         *label _NAME_="Variable";
51698     +         label _NAME_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_variable, noquote))" ;
51699     +         label Cluster = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_cluster, noquote))" ;
51700     +         label GCluster = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_gcluster, noquote))" ;
51702     +         %if &globalclusid ne %then %do;
51703     +          GCluster = "GC&globalclusid";
51704     +          Cluster = "GC&globalclusid._CLUS"||strip(COL1);
51705     +         %end;
51706     +         %else %do;
51707     +         Cluster = "CLUS"||strip(COL1);
51708     +        %end;
51709     +         rename COL2 = RSqWithOwnClusComp;
51710     +         *label COL2 = "R-Square With Own Cluster Component";
51711     +         label COL2 = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_ownrsq, noquote))" ;
51713     +   run;
51714     +   proc sort data =&outdata;
51715     +        by Cluster RSqWithOwnClusComp;
51716     +   run;
51717     +   proc datasets lib = work nolist;
51718     +           delete _tmpds;
51719     +   run;
51720     +   quit;
51721     +%mend MakeOwnRSquare;
51723     +%macro MakeClusStructCorrData(indata=, outdata=, globalclusid=, ncluster=, Rsquare=N);
51724     +    data &outdata(drop= _NCL_  _TYPE_);
51725     +       %if &globalclusid ne %then %do;
51726     +        length GCluster $16;
51727     +        %end;
51728     +       set &indata;
51729     +       if ^(strip(_NCL_) eq &ncluster and strip(_TYPE_) eq 'STRUCTUR') then delete;
51730     +       %if &globalclusid ne %then %do;
51731     +         GCluster = "GC&globalclusid";
51732     +         _NAME_ = "GC&globalclusid._"||upcase(_NAME_);
51733     +         rename _NAME_ = Cluster;
51734     +         label _NAME_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_cluster, noquote))" ;
51735     +         label GCluster = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_gcluster, noquote))" ;
51737     +       %end;
51738     +       %else %do;
51739     +         _NAME_ = upcase(_NAME_);
51740     +         rename _NAME_ = Cluster;
51741     +         label _NAME_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_cluster, noquote))" ;
51742     +         label GCluster = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_gcluster, noquote))" ;
51744     +       %end;
51745     +     run;
51746     +    %if &RSquare eq Y %then %do;
51747     +     data corr_tmp;
51748     +          set &outdata;
51749     +     run;
51750     +     %let istart = 2;
51751     +     %if &globalclusid ne %then %let istart = 3;
51752     +     data &outdata;
51753     +          set &outdata;
51754     +          %let dsid = %sysfunc(open(work.corr_tmp));
51755     +          %let nvar = %sysfunc(attrn(&dsid, NVAR));
51756     +          %do i =&istart %to &nvar;
51757     +            %let _name = %sysfunc(varname(&dsid, &i));
51758     +            %let _name_md = &_name.**2;
51759     +                &_name = &_name_md;
51760     +          %end;
51761     +      %let dsid= %sysfunc(close(&dsid));
51762     +      run;
51763     +      proc datasets lib = work nolist;
51764     +           delete corr_tmp;
51765     +      run;
51766     +    %end;
51767     +     quit;
51768     +%mend MakeClusStructCorrData;
51770     +/*
51771     +%MakeClusStructCorrData(indata=playpen._outstat, outdata=_structrsq , ncluster=7, Rsquare=Y);
51772     +*/
51774     +%macro FindNextClosestClusByVar(indata=, outdata=, globalclusid=, ncluster=);
51776     +     /* The indata should be the outdata
51777     +        from %MakeClusStructCorrData(indata=, outdata=, ); */
51779     +     proc sort data =&indata out=_tmpclusRsq;
51780     +     by cluster;
51781     +     run;
51783     +     proc transpose data =_tmpclusRsq out=_tmpclusRsq;
51784     +      by cluster;
51785     +     run;
51787     +     proc sort data=_tmpclusRsq;
51788     +        by _NAME_ COL1;
51789     +     run;
51791     +     data _tmpclusRsq;
51792     +         length _NAME_ $32;
51793     +         set _tmpclusRsq; by _NAME_;
51794     +          _NAME_ = upcase(_NAME_);
51795     +          %if &ncluster ne 1 %then %do;
51796     +             if last._NAME_ then delete;
51797     +          %end;
51798     +          %else %do;
51799     +             COL1 = 0;
51800     +          %end;
51801     +     run;
51802     +     /* need to sort again */
51803     +     proc sort data=_tmpclusRsq;
51804     +        by _NAME_ COL1;
51805     +     run;
51807     +     data &outdata;
51808     +         set _tmpclusRsq; by _NAME_;
51809     +         Cluster = upcase(Cluster);
51810     +         if last._NAME_ then output;
51811     +         *label  COL1 = 'R-Sqaure with Next Cluster Component';
51812     +         label COL1 = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nextrsq, noquote))" ;
51813     +         rename COL1 = RSqWithNextClusComp;
51814     +         Cluster = upcase(Cluster);
51815     +         rename Cluster = ClosestCluster;
51816     +         *label  Cluster = "Next Closest Cluster";
51817     +         label Cluster = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nextclus, noquote))" ;
51818     +         rename _NAME_ = Variable;
51819     +         label  _NAME_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_variable, noquote))" ;
51820     +    run;
51823     +    %if &globalclusid ne %then %do;
51824     +    data &outdata;
51825     +       length GCluster $16;
51826     +       set &outdata;
51827     +       GCluster = "GC&globalclusid";
51828     +       run;
51829     +    %end;
51830     +    proc datasets lib = work nolist;
51831     +           delete _tmpclusRsq;
51832     +    run;
51833     +    quit;
51834     +%mend FindNextClosestClusByVar;
51837     +%macro FindNextClosestClusByCluster(indata=, outdata=, globalclusid=, ncluster=);
51838     +     /* The indata should be the outdata from %MakeInterClusCorrData(indata=, outdata=, ); */
51839     +     proc sort data =&indata out=_tmpclusRsq;
51840     +     by cluster;
51841     +     run;
51842     +     proc transpose data =_tmpclusRsq out=_tmpclusRsq;
51843     +     by cluster;
51844     +     run;
51845     +     proc sort data=_tmpclusRsq;
51846     +        by _NAME_ col1;
51847     +     run;
51848     +     data _tmpclusRsq;
51849     +         length _NAME_ $32;
51850     +         set _tmpclusRsq; by _NAME_;
51851     +          _NAME_ = upcase(_NAME_);
51852     +          %if &ncluster ne 1 %then %do;
51853     +             if last._NAME_ then delete;
51854     +          %end;
51855     +          %else %do;
51856     +             COL1 = 0;
51857     +          %end;
51858     +     run;
51859     +     data &outdata;
51860     +         set _tmpclusRsq; by _NAME_;
51861     +         Cluster = upcase(Cluster);
51862     +         if last._NAME_ then output;
51863     +         *label  COL1 = 'R-Sqaure with Next Cluster Component';
51864     +         label COL1 = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nextrsq, noquote))" ;
51865     +         rename COL1 = RSqWithNextClusComp;
51866     +         Cluster = upcase(Cluster);
51867     +         rename Cluster = ClosestCluster;
51868     +         *label  Cluster = "Next Closest Cluster";
51869     +         label Cluster = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nextclus, noquote))" ;
51870     +         rename _NAME_ = Variable;
51871     +         *label  _NAME_ = "Variable";
51872     +         label  _NAME_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_variable, noquote))" ;
51874     +    run;
51875     +    %if &globalclusid ne %then %do;
51876     +    data &outdata;
51877     +       length GCluster $16;
51878     +       set &outdata;
51879     +       GCluster = "GC&globalclusid";
51880     +       run;
51881     +    %end;
51883     +    proc datasets lib = work nolist;
51884     +           delete _tmpclusRsq;
51885     +    run;
51887     +    quit;
51888     +%mend FindNextClosestClusByCluster;
51890     +%macro MakeVarClusResultTable(indata1=, indata2=, indata3=, outdata=, globalclusid=, ncluster=, selectedcomp=clustercomp);
51891     +/*----
51892     +  indata1=_ownRsq, indata2=_nextVarRsq, indata3=_nextClusRSq,
51893     +-----------*/
51895     +proc sort data =&indata1;
51896     +    by Variable;
51897     +run;
51898     +proc sort data =&indata2;
51899     +    by Variable;
51900     +run;
51901     +data &outdata;
51902     +    merge &indata1 &indata2;
51903     +    by Variable;
51904     +    length Type $16;
51905     +    Type = 'Variable';
51906     +    *label Type ='Type';
51907     +    label Type = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_type, noquote))" ;
51908     +run;
51911     +data &indata3;
51912     +    set  &indata3 ;
51913     +    length RSqWithOwnClusComp 8.;
51914     +    Cluster = Variable;
51915     +    RSqWithOwnClusComp = 1;
51916     +    *label RSqWithOwnClusComp = "R-Square With Own Cluster Component";
51917     +    label RSqWithOwnClusComp = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_ownrsq, noquote))" ;
51918     +    length Type $16;
51919     +    Type = 'ClusterComp';
51920     +    label Type = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_type, noquote))" ;
51922     +;
51923     +run;
51925     +proc sort data=&outdata;
51926     +    by Cluster;
51927     +run;
51928     +proc sort data =&indata3;
51929     +    by Cluster;
51930     +run;
51932     +data &outdata;
51933     +     set &outdata &indata3;
51934     +     by Cluster;
51935     +run;
51938     +/* Create the Selected variable with all YES */
51940     +data &outdata;
51941     +     set &outdata;
51942     +     length RsqRatio 8.;
51943     +     length Selected $8;
51944     +     *label RSqRatio = "1-R**2 Ratio";
51945     +     label RSqRatio =  "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_oneminusrsq, noquote))" ;
51946     +     *label Selected = "Variable Selected";
51947     +     label Selected = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_varselected, noquote))" ;
51948     +     RsqRatio = (1-RSqWithOwnClusComp)/(1-RSqWithNextClusComp);
51949     +     Selected ='YES';
51950     +     rename _LABEL_ = Label;
51951     +     label _LABEL_ =  "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_label, noquote))" ;
51952     +run;
51955     +/*----  Selected = Y/N will be assigened at the %score                   -------+
51956     +        Just create the Selected variable with all YES at the step above
51957     + +------------------------------------------------------------------------------+
51959     +proc sort data=&outdata;
51960     +    by Cluster RsqRatio;
51961     +run;
51963     +%if &selectedcomp eq CLUSTERCOMP %then %do;
51964     +data &outdata;
51965     +     set &outdata; by Cluster;
51966     +     length Selected $8;
51967     +     label Selected = "Variable Selected";
51968     +     if  first.Cluster then Selected ='Yes';
51969     +     else Selected = 'No';
51970     +    run;
51971     +%end;
51972     +%else %do;
51973     +data &outdata(drop = _var _varchange);
51974     +     set &outdata; retain _var 0; by Cluster;
51975     +     length Selected $8;
51976     +     label Selected = "Variable Selected";
51977     +     if first.Cluster then  _varchange = 0;
51978     +     else _varchange =1;
51979     +     if _var ne _varchange then  Selected  = 'Yes';
51980     +     else Selected = 'No';
51981     +     if last.cluster then  _var = 0;
51982     +     else _var = _varchange;
51983     +run;
51984     +%end;
51986     +--------------------------------------------------------------*/
51988     +quit;
51989     +%mend MakeVarClusResultTable;
51991     +%Macro MakePlotDataFromCorrTable(indata=, outdata=, globalclusid=);
51992     +     proc sort data =&indata;
51993     +        by cluster;
51994     +     run;
51995     +     proc transpose data =&indata
51996     +          out=&outdata(drop=_LABEL_ rename=(_NAME_ = Y Cluster=X Col1= Correlation));
51997     +          by cluster;
51998     +     run;
51999     +     data &outdata;
52000     +          set  &outdata;
52001     +          label x= "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_cluster, noquote))" ;
52002     +          label Y= "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_cluster, noquote))" ;
52003     +          label Correlation = "%sysfunc(sasmsg(sashelp.dmine, rpt_correlation_vlabel, noquote))" ;
52004     +     run;
52005     +     %if &globalclusid ne %then %do;
52006     +     data &outdata;
52007     +          Length GCluster $16;
52008     +          label GCluster = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_gcluster, noquote))" ;
52009     +          set  &outdata;
52010     +          GCluster ="GC&globalclusid.";
52011     +          run;
52012     +     %end;
52014     +%Mend MakePlotDataFromCorrTable;
52017     +%macro MakeCorrelation(indata=,
52018     +                       outstat=_tmpoutstat,
52019     +                       corrmatrix=N,
52020     +                       outcorr=_tmpoutcorr,
52021     +                       includeclassvar=N,
52022     +                       target=,
52023     +                       freq=,
52024     +                       weight=);
52025     +   %if &target eq  %then %do;
52027     +       proc varclus data=&indata outstat=&outstat hi maxclusters=1 noprint;
52028     +            var %EM_INTERVAL_INPUT %EM_INTERVAL_REJECTED
52029     +       %if &includeclassvar eq Y %then %do;
52030     +          %let dsid = %sysfunc(open(&EM_USER_OUTDUMMY));
52031     +          %let nvar = %sysfunc(attrn(&dsid, NVAR));
52032     +          %do i = 2 %to &nvar;
52033     +          %let varname = %sysfunc(varname(&dsid, &i));
52034     +          &varname
52035     +          %end;
52036     +       %end;
52037     +       ;
52038     +      %if &freq ne  %then %do;
52039     +          freq &freq;
52040     +      %end;
52041     +      %if &weight ne  %then %do;
52042     +          weight &weight;
52043     +      %end;
52045     +      run;
52046     +      %if &corrmatrix eq Y %then %do;
52047     +      data  &outcorr (drop = _NCL_ _TYPE_);
52048     +           set  &outstat ;
52049     +           if _TYPE_ ='CORR' then output;
52050     +      run;
52051     +      %end;
52052     +    %end;
52053     +    %else %do;
52054     +       proc corr data=&indata outp=&outstat noprint;
52055     +            var
52056     +       %let dsid = %sysfunc(open(&indata));
52057     +       %let nvar = %sysfunc(attrn(&dsid, NVAR));
52058     +          %do i = 1 %to &nvar;
52059     +              %let _name = %sysfunc(varname(&dsid, &i));
52060     +              %if &_name ne &target %then;
52061     +              &_name
52062     +           %end;
52063     +        %let dsid= %sysfunc(close(&dsid));
52064     +        ;
52065     +        with &target;
52066     +        run;
52067     +    %end;
52068     +    quit;
52069     +%mend MakeCorrelation;
52072     +%macro MakeCorrelationDistance(indata=,
52073     +                               outdata=,
52074     +                               rsquare = N
52075     +                               );
52076     +    data corr_tmp;
52077     +        set &indata;
52078     +        if _N_ = 1 then do;
52079     +           output;
52080     +           stop;
52081     +         end;
52082     +    run;
52083     +    %if &outdata ne  %then %let  _outdata = &outdata;
52084     +    %else %let _outdata = &indata;
52086     +    data &_outdata;
52087     +         set &indata;
52089     +         %let dsid = %sysfunc(open(work.corr_tmp));
52090     +         %let nvar = %sysfunc(attrn(&dsid, NVAR));
52091     +          %do i = 2 %to &nvar;
52092     +              %let _name = %sysfunc(varname(&dsid, &i));
52093     +              %if &rsquare eq Y %then %let _name_md = &_name.**2;
52094     +              %else  %let _name_md = &_name;
52095     +              &_name = 1- &_name_md;
52096     +          %end;
52097     +      %let dsid= %sysfunc(close(&dsid));
52098     +      run;
52099     +      proc datasets lib = work nolist;
52100     +           delete corr_tmp;
52101     +      run;
52102     +      quit;
52103     +  %mend MakeCorrelationDistance;
52106     +%macro UpdateOutStatCorrToDistance(indata=, /* indata should be a outstat from proc varclus */
52107     +                                   rsquare = N
52108     +                                   );
52109     +    data corr_tmp;
52110     +        set &indata;
52111     +    run;
52112     +    proc sql noprint;
52113     +           update &indata
52114     +           set
52115     +     %let dsid = %sysfunc(open(work.corr_tmp));
52116     +     %let nvar = %sysfunc(attrn(&dsid, NVAR));
52117     +          %do i = 4 %to &nvar;
52118     +          %let _name = %sysfunc(varname(&dsid, &i));
52119     +             %if &rsquare eq Y %then %let _name_md = &_name.**2;
52120     +            %else  %let _name_md = &_name;
52121     +            %if &i < &nvar %then %do;
52122     +               &_name = 1- &_name_md ,
52123     +            %end;
52124     +            %else %do;
52125     +               &_name = &_name_md where _TYPE_ eq 'CORR' ;
52126     +            %end;
52127     +          %end;
52128     +      %let dsid= %sysfunc(close(&dsid));
52130     +      select * from &indata;
52131     +      run;
52132     +     data &indata( drop = _NCL_);
52133     +           set &indata;
52134     +           if _TYPE_ not in ('CORR', 'STD', 'N', 'MEAN') then delete;
52135     +           if _TYPE_ ='CORR' then _TYPE_ ='DISTANCE';
52136     +     run;
52137     +     data &indata(DROP = _NCL_);
52138     +           set &indata;
52139     +           if _TYPE_ = 'CORR' then _TYPE_ ='DISTANCE';
52140     +           if _TYPE_ not in ('DISTANCE', 'N', 'STD', 'MEAN') then delete;
52141     +           rename _NAME_ = _VAR_;
52142     +     run;
52143     +     proc datasets lib = work nolist;
52144     +           delete corr_tmp;
52145     +     run;
52146     +     quit;
52147     + %mend UpdateOutStatCorrToDistance;
52150     +%macro HierClusWithCorr(indata= ,
52151     +                        ncluster=,
52152     +                        method = Ward,
52153     +                        outtree = _outtree,
52154     +                        idvar =_VAR_,
52155     +                        outdata=,
52156     +                        rescore = N,
52157     +                        newncluster=
52158     +                        );
52159     +      %global &newncluster;
52160     +      %if &rescore ne Y %then %do;
52161     +      proc cluster data=&indata(type=Distance where=(upcase(strip(_TYPE_)) = "DISTANCE"))
52162     +                   method=&method outtree=&outtree noprint;
52163     +           id &idvar;
52164     +      run;
52165     +      %end;
52166     +      proc tree data=&outtree nclusters = &ncluster out=&outdata noprint;
52167     +      run;
52168     +      /* ----- Check some variables like CL1, CL5..., remove them ----*/
52169     +      proc contents data =&indata out=_outcontent(keep=NAME) noprint;
52170     +      run;
52171     +      data _outcontent;
52172     +          set _outcontent;
52173     +          if NAME in ('_TYPE_' , '_VAR_') then delete;
52174     +          index = 1;
52175     +          rename NAME = _NAME_;
52176     +      run;
52177     +      proc sort data=_outcontent;
52178     +          by _NAME_;
52179     +      run;
52180     +      proc sort data =&outdata;
52181     +           by _NAME_;
52182     +      run;
52183     +      data &outdata(drop=index);
52184     +          merge &outdata _outcontent;
52185     +          by _NAME_;
52186     +          if index = . then delete;
52187     +      run;
52188     +      /*-----------------------------------------------------------*/
52189     +      data &outdata;
52190     +           length CLUSNAME $16;
52191     +           set &outdata;
52192     +           if CLUSTER > &ncluster then delete;
52193     +           CLUSNAME='GC'||strip(CLUSTER);
52194     +           *label CLUSNAME = "Cluster Name";
52195     +           label CLUSNAME  = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_clustername, noquote))" ;
52196     +           rename _NAME_ = VARIABLE ;
52197     +           *label _NAME_ = "Variable";
52198     +           *label CLUSTER = "Cluster";
52199     +           label _NAME_ ="%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_variable, noquote))" ;
52200     +           label CLUSTER ="%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_cluster, noquote))" ;
52201     +      run;
52202     +      proc sort data=&outdata out=&outdata;
52203     +           by CLUSTER;
52204     +      run;
52205     +      proc means data =&outdata noprint;
52206     +           output out=_meanout;
52207     +      run;
52208     +      data _null_;
52209     +            set _meanout;
52210     +            if strip(_STAT_) eq 'MAX' then do;
52211     +            call symput("&newncluster", CLUSTER);
52212     +            stop;
52213     +            end;
52214     +      run;
52216     +      proc datasets lib = work nolist;
52217     +           delete _outcontent _meanout;
52218     +      run;
52219     +      quit;
52220     +%mend  HierClusWithCorr;
52222     +%macro CreateScoreCode2(indata=, ncluscomp=, globalclusid=, fileref=);
52224     +     data _tmpindata;
52225     +          set &indata;
52226     +          if (_TYPE_ in ('SCORE' 'MEAN' 'STD') and _NCL_ = &ncluscomp ) or (_TYPE_ in ('MEAN' 'STD'));
52227     +          if _TYPE_ = 'MEAN' then _NAME_='MEAN';
52228     +          if _TYPE_ = 'STD' then _NAME_='STD';
52229     +          if _TYPE_ = 'SCORE' then _NAME_=upcase("GC&globalclusid._"||_NAME_);
52230     +          DROP _TYPE_ _NCL_;
52231     +     run;
52233     +     filename _file_  "&fileRef";
52235     +     data _null_;
52236     +        FILE _file_ MOD;
52237     +        put ' ';
52238     +        put "/*-------------------------------------------------*/";
52239     +        put '/* ' "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_score_title_gclus, noquote, &globalclusid))" '*/';
52240     +        put "/*-------------------------------------------------*/";
52241     +        put ' ';
52242     +        %let dsid = %sysfunc(open(work._tmpindata));
52244     +        %let nvar = %sysfunc(attrn(&dsid, NVAR));
52245     +        %let vn_name =%sysfunc(varnum(&dsid, _NAME_));
52246     +        %let k = 1;
52247     +        %do %while(^%sysfunc(fetch(&dsid)));
52248     +               %let _name = %sysfunc(getvarc(&dsid, &vn_name));
52249     +               %if &k > 2 %then %do;
52250     +                %let cn = %eval(&k-2);
52251     +                 put "&_name = 0 ; /*---" "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_score_gcluscompnum, noquote, &globalclusid, &cn))" "------ */";
52252     +                %end;
52253     +                %let k = %eval(&k+1);
52255     +        %end;
52256     +        %let rc = %sysfunc(rewind(&dsid));
52258     +        %do j= 2 %to &nvar;
52259     +            %let _varname = %sysfunc(varname(&dsid, &j));
52260     +            %do %while(^%sysfunc(fetch(&dsid)));
52261     +                %let _name = %sysfunc(getvarc(&dsid, &vn_name));
52262     +                %if &_name = MEAN %then
52263     +                %let _mean = %sysfunc(getvarn(&dsid, &j));
52264     +                %else %if &_name = STD %then
52265     +                %let _std = %sysfunc(getvarn(&dsid, &j));
52266     +                %else %do;
52267     +                      %let coeff =  %sysfunc(getvarn(&dsid, &j));
52268     +                      %let abscoeff = %sysfunc(abs(&coeff));
52269     +                          %if &abscoeff >  0 %then %do;
52270     +                       put "&_name = &_name+&coeff * (&_varname - &_mean)/&_std;";
52271     +                           %end;
52272     +                 %end;
52273     +             %end;
52274     +             %let rc = %sysfunc(rewind(&dsid));
52275     +         %end;
52277     +        %let dsid= %sysfunc(close(&dsid));
52279     +     run;
52281     +     filename _file_;
52282     +     proc datasets lib = work nolist;
52283     +           delete _tmpindata;
52284     +     run;
52285     +     quit;
52286     +%mend CreateScoreCode2;
52289     +%macro MakeDeltaCode2(groupds=,deltacodefile=);
52291     +     /*--- Build Code to Modify Metadata ---*/
52292     +     filename X "&deltacodefile";
52293     +     data _null_;
52294     +        FILE X;
52295     +        set &groupds end=eof;
52296     +        if _N_=1 then do;
52297     +           %if &EM_PROPERTY_INCLUDECLASSVAR eq Y %then %do;
52298     +            put "if upcase(strip(ROLE)) ='INPUT' and upcase(strip(LEVEL)) ^='INTERVAL' then ROLE ='REJECTED' ;";
52299     +           %end;
52300     +           put "if upcase(strip(ROLE))='INPUT' and upcase(strip(LEVEL))='INTERVAL' then do;";
52301     +           put "if upcase(strip(NAME)) in (";
52302     +        end;
52303     +        if Strip(upcase(Selected)) eq 'YES' then do;
52304     +           string = '"'!!trim(left(VARIABLE))!!'"';
52305     +           put string;
52306     +        end;
52307     +        if eof then do;
52308     +           put ') then ROLE="INPUT";';
52309     +           put 'else ROLE="REJECTED";';
52310     +           put 'end;';
52312     +           %if %upcase(&EM_PROPERTY_HIDEVARIABLE) eq Y %then %do;
52313     +             put 'if upcase(strip(ROLE)) = "REJECTED" then delete ;';
52314     +           %end;
52315     +        end;
52316     +     run;
52317     +     quit;
52319     +     filename X;
52320     +     quit;
52321     +%mend MakeDeltaCode2;
52323     +%macro getInitialGClusterNumber(indata=, ninput=, ndummy=0, div=100, ngc=);
52324     +  %global &ngc;
52325     +  data _null_;
52326     +  %if &indata ne %then %do;
52327     +      %let dsid = %sysfunc(open(&indata));
52328     +           %let nvar = %sysfunc(attrn(&dsid, NVAR));
52329     +      %let dsid = %sysfunc(close(&dsid));
52330     +  %end;
52331     +  %else %do;
52332     +       %let nvar = %eval(&ninput+&ndummy); ;
52333     +  %end;
52334     +  %let numgc = %eval(&nvar/&div+2);
52335     +  %let &ngc = &numgc;
52336     +   run;
52337     +  quit;
52338     +%mend getInitialGClusterNumber;
52341     +%macro MakeGobalConstellData(indata=, outlink=, outnode=);
52342     +data &outlink(drop = Selected);
52343     +     set &indata;
52344     +     LINKID = _N_;
52345     +     label LINKID = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_linkid, noquote))" ;
52346     +run;
52347     +data &outnode(keep=NODEID TYPE LABEL);
52348     +    set &indata;
52349     +    length TYPE $16;
52350     +    rename VARIABLE = NODEID;
52351     +    *label  CLUSNAME="Node ID";
52352     +    label CLUSNAME= "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nodeidvar, noquote))" ;
52353     +    TYPE = "VARIABLE";
52354     +    *label TYPE = "Node Type";
52355     +    label TYPE =  "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nodetype, noquote))" ;
52356     +    run;
52357     +data _tmp(keep=NODEID TYPE LABEL);
52358     +    set &indata;
52359     +    length TYPE $16;
52360     +    rename CLUSNAME = NODEID;
52361     +    label  CLUSNAME= "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nodeidvar, noquote))" ;
52362     +    TYPE = "GCLUSTER";
52363     +    label TYPE = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nodetype, noquote))" ;
52364     +    run;
52365     +proc sort data=_tmp;
52366     +    by NODEID;
52367     +run;
52368     +data _tmp;
52369     +    set _tmp; by NODEID;
52370     +    if first.NODEID then output;
52371     +run;
52372     +proc sort data=&outnode;
52373     +    by NODEID;
52374     +run;
52375     +data  &outnode;
52376     +    set _tmp &outnode;
52377     +run;
52378     +proc datasets lib = work nolist;
52379     +     delete _tmp;
52380     +run;
52381     +quit;
52382     +%mend MakeGobalConstellData;
52384     +/* Make contellation plot data among GCLUSTERS */
52386     +%Macro MakeGClusterConstData(indata=, inoutrsq=, outnode=, outlink=);
52388     +data &outlink(keep = _NAME_ _PARENT_ _LABEL_ LINKID);
52389     +     set &indata;
52390     +     LINKID = _N_;
52391     +     if upcase(substr(strip(_NAME_),1, 2))="CL" then do;
52392     +        _NAME_ = "ROOT"||upcase(substr(strip(_NAME_),5));
52393     +     end;
52394     +     if _PARENT_ ne " " and upcase(substr(strip(_PARENT_),1, 2))="CL" then do;
52395     +        _PARENT_ = "ROOT"||upcase(substr(strip(_PARENT_),5));
52396     +     end;
52397     +     if upcase(substr(strip(_LABEL_),1, 2))="CL" then do;
52398     +        _LABEL_ = "ROOT"||upcase(substr(strip(_LABEL_),5));
52399     +    end;
52400     +run;
52402     +data _tmp_outrsquare;
52403     +        set &inoutrsq;
52404     +        if upcase(strip(TYPE)) = 'CLUSTERCOMP' then delete;
52405     +run;
52407     +proc freq data =_tmp_outrsquare noprint;
52408     +         tables GCluster/out=_tmp_GCLUSFREQ(rename=(GCLUSTER=_NAME_));
52409     +run;
52411     +data &outnode(keep=_NAME_ TYPE LABEL);
52412     +    set &outlink;
52413     +    length TYPE $16;
52414     +    length LABEL $100;
52415     +    /*label CLUSNAME= "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nodeidvar, noquote))" ;*/
52417     +    if upcase(substr(strip(_NAME_),1, 2))='GC' then do;
52418     +    TYPE = "GCLUSTER";
52419     +    LABEL = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_gcluster, noquote)):"||_NAME_;
52420     +    end;
52421     +    else do;
52422     +    TYPE= "ROOT";
52423     +    LABEL= _NAME_;
52424     +    end;
52425     +    label TYPE  =  "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nodetype, noquote))" ;
52426     +    label LABEL =  "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_label, noquote))" ;
52427     +    label _NAME_ =  "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_nodeidvar, noquote))" ;
52428     +    run;
52430     +proc sort data=&outnode;
52431     +     by _NAME_;
52432     +proc sort data=_tmp_GCLUSFREQ;
52433     +     by _NAME_;
52434     +run;
52436     +data  &outnode;
52437     +     merge &outnode _tmp_GCLUSFREQ; by _NAME_;
52438     +     if COUNT=. then COUNT=1;
52439     +run;
52441     +proc datasets lib = work nolist;
52442     +     delete _tmp_outrsquare _tmp_GCLUSFREQ;
52443     +run;
52445     +quit;
52446     +%Mend MakeGClusterConstData;
52449     +%macro CreateGClusterScoreCode(indata=,  globalclusid=, fileref=);
52451     +    data _gscoretmpds;
52452     +          set &indata;
52453     +          if (_TYPE_ in ('SCORE' 'MEAN' 'STD') and _NCL_ = 1 ) or (_TYPE_ in ('MEAN' 'STD'));
52454     +          if _TYPE_ = 'MEAN' then _NAME_='MEAN';
52455     +          if _TYPE_ = 'STD' then _NAME_='STD';
52456     +          if _TYPE_ = 'SCORE' then _NAME_ = "GC"||strip(&globalclusid);
52457     +          DROP _TYPE_ _NCL_;
52458     +     run;
52460     +    /*  %let gscorefile =  %bquote(&EM_NODEDIR)&EM_DSEP.gclusterscore.sas;
52461     +        GCluster Component &globalclusid ------ */
52463     +    filename _file_  "&fileref";
52465     +    data _null_;
52466     +        %if &globalclusid eq 1 %then %do;
52467     +          FILE _file_;
52468     +        %end;
52469     +        %else %do;
52470     +          FILE _file_ MOD;
52471     +        %end;
52473     +        %let dsid = %sysfunc(open(work._gscoretmpds));
52474     +        %let nvar = %sysfunc(attrn(&dsid, NVAR));
52475     +        %let vn_name =%sysfunc(varnum(&dsid, _NAME_));
52477     +        %let k = 1;
52478     +        %do %while(^%sysfunc(fetch(&dsid)));
52479     +                %let _name = %sysfunc(getvarc(&dsid, &vn_name));
52480     +                %if &k > 2 %then %do;
52481     +                put "&_name = 0 ; ";
52482     +                %end;
52483     +                %let k = %eval(&k+1);
52484     +        %end;
52486     +        %let rc = %sysfunc(rewind(&dsid));
52487     +        %do i= 2 %to &nvar;
52488     +            %let _varname =  %sysfunc(varname(&dsid, &i));
52489     +            %do %while(^%sysfunc(fetch(&dsid)));
52490     +                %let _name = %sysfunc(getvarc(&dsid, &vn_name));
52491     +                %if &_name = MEAN %then
52492     +                %let _mean = %sysfunc(getvarn(&dsid, &i));
52493     +                %else %if &_name = STD %then
52494     +                %let _std = %sysfunc(getvarn(&dsid, &i));
52495     +                %else %do;
52496     +                      %let coeff =  %sysfunc(getvarn(&dsid, &i));
52497     +                      %let abscoeff = %sysfunc(abs(&coeff));
52498     +                          %if &abscoeff >  0 %then %do;
52499     +                       put "&_name = &_name+&coeff * (&_varname - &_mean)/&_std;";
52500     +                           %end;
52501     +                 %end;
52502     +             %end;
52503     +             %let rc = %sysfunc(rewind(&dsid));
52505     +         %end;
52507     +        %let dsid= %sysfunc(close(&dsid));
52508     +       run;
52511     +       proc datasets lib=work nolist;
52512     +            delete _gscoretmpds;
52513     +       run;
52514     +      quit;
52516     +%mend CreateGClusterScoreCode;
52519     +%macro MakeGClusterCorrelation(Indata=, ngcluster=, gscorecode=, outrsquare=);
52521     +   %EM_REGISTER(KEY=GSCORE, TYPE=DATA);
52522     +   %EM_GETNAME(KEY=GSCORE, TYPE=DATA);
52523     +   %EM_REGISTER(KEY=GSCORESTAT, TYPE=DATA);
52524     +   %EM_GETNAME(KEY=GSCORESTAT, TYPE=DATA);
52525     +   %EM_REGISTER(KEY=GSCORETREE, TYPE=DATA);
52526     +   %EM_GETNAME(KEY=GSCORETREE, TYPE=DATA);
52527     +   %EM_REGISTER(KEY=GSCORECORR, TYPE=DATA);
52528     +   %EM_GETNAME(KEY=GSCORECORR, TYPE=DATA);
52529     +   %EM_REGISTER(KEY=GSCORECORRPLOT, TYPE=DATA);
52530     +   %EM_GETNAME(KEY=GSCORECORRPLOT, TYPE=DATA);
52531     +   %EM_REGISTER(KEY=GCLUSLINK, TYPE=DATA);
52532     +   %EM_GETNAME(KEY=GCLUSLINK, TYPE=DATA);
52533     +   %EM_REGISTER(KEY=GCLUSNODE, TYPE=DATA);
52534     +   %EM_GETNAME(KEY=GCLUSNODE, TYPE=DATA);
52536     +   filename gsfile "&gscorecode";
52538     +   data &EM_USER_GSCORE;
52539     +             set &indata;
52540     +             %include  gsfile;
52541     +        keep
52542     +        %do i=1 %to &ngcluster;
52543     +         %let gcvarname = GC&i;
52544     +         &gcvarname
52545     +        %end;
52546     +     ;
52547     +   run;
52549     +   proc varclus data=&EM_USER_GSCORE outstat=&EM_USER_GSCORESTAT outtree=&EM_USER_GSCORETREE
52550     +    %if %upcase(&EM_PROPERTY_CLUSCOMP) eq CENTROID %then %do; centroid %end;
52551     +    %if %upcase(&EM_PROPERTY_CLUSSOURCE) eq COV %then %do; cov %end;
52552     +    %if %upcase(&EM_PROPERTY_CLUSHIERACHY) eq Y %then %do; hi %end;
52553     +    noprint  ;
52554     +     var
52555     +       %do i=1 %to &ngcluster;
52556     +         %let gcvarname = GC&i;
52557     +         &gcvarname
52558     +        %end;
52559     +   ;
52560     +   run;
52563     +   %MakeVarClusCorrData(statds=&EM_USER_GSCORESTAT, corrds=&EM_USER_GSCORECORR, corrplotds=&EM_USER_GSCORECORRPLOT );
52564     +   data &EM_USER_GSCORECORRPLOT ;
52565     +        set &EM_USER_GSCORECORRPLOT;
52566     +        rename _X_ = X;
52567     +        rename _Y_ = Y;
52568     +        label _X_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_gcluster, noquote))" ;
52569     +        label _Y_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_gcluster, noquote))" ;
52570     +   run;
52572     +   %MakeGClusterConstData(indata=&EM_USER_GSCORETREE, inoutrsq=&outrsquare, outnode=&EM_USER_GCLUSNODE, outlink=&EM_USER_GCLUSLINK);
52574     +   data &EM_USER_GSCORETREE;
52575     +        length _NAME_ $32;
52576     +        length _LABEL_ $100;
52577     +        set &EM_USER_GSCORETREE(DROP=_LABEL_);
52578     +        if upcase(substr(strip(_NAME_),1, 2))='GC' then do;
52579     +         _LABEL_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_gcluster, noquote)):"||_NAME_;
52580     +        end;else do;
52581     +         _LABEL_ = _NAME_;
52582     +        end;
52583     +       label _LABEL_ = "%sysfunc(sasmsg(sashelp.dmine, rpt_varclus_label_variable, noquote))";
52585     +   run;
52587     +   quit;
52589     +%mend MakeGClusterCorrelation;
NOTE: %INCLUDE (level 1) ending.
MPRINT(MAIN):   filename temp;
NOTE: Fileref TEMP has been deassigned.
MPRINT(SETPROPERTIES):  ;
MPRINT(SETPROPERTIES):  ;
MPRINT(SETPROPERTIES):  ;
MPRINT(SETPROPERTIES):  ;
MPRINT(SETPROPERTIES):  ;
MPRINT(SETPROPERTIES):  ;
MPRINT(SETPROPERTIES):  ;
MPRINT(SETPROPERTIES):  ;
MPRINT(SETPROPERTIES):  ;
MPRINT(SETPROPERTIES):  ;
MPRINT(SETPROPERTIES):  ;
MPRINT(SETPROPERTIES):  ;
MPRINT(SETPROPERTIES):  ;
MPRINT(MAIN):  ;
MPRINT(MAIN):   filename temp catalog 'sashelp.emexpl.variableclustering_score.source';
NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMEXPL.VARIABLECLUSTERING_SCORE.SOURCE.
52592     +%macro score;
52594     +filename temp catalog 'sashelp.emexpl.variableclustering_score_macros.source';
52595     +%include temp;
52596     +filename temp;
52598     +%EM_GETNAME(key=VARCLUSMETA, type=DATA) ;
52600     +data _null_;
52601     +         set &EM_USER_VARCLUSMETA;
52602     +         if _N_=1 then
52603     +         call symput('_trainnum', TrainNum);
52604     +         call symput('_exportedcomp', ExportedComp);
52605     +         call symput('_hidevariable', HideVariable);
52606     +         call symput('_newTrain', NewTrain);
52607     +run;
52609     +%if &_newTrain = N %then %do;
52610     +        %if &EM_PROPERTY_EXPORTEDCOMP eq &_exportedcomp %then %let _exportedCompChanged = N;
52611     +        %else %let _exportedCompChanged = Y;
52612     +        %if &EM_PROPERTY_HIDEVARIABLE eq &_hidevariable %then %let _hideVariableChanged = N;
52613     +        %else  %let _hideVariableChanged = Y;
52614     +%end;
52615     +%else %do;
52616     +        %let _exportedCompChanged = Y;
52617     +        %let _hideVariableChanged = Y;
52618     +%end;
52620     +%if (&_trainnum = 1 ) or %upcase(&EM_PROPERTY_TWOSTAGECLUS) = NO %then %do;
52621     +     filename temp catalog 'sashelp.emexpl.variableclustering_score1.source';
52622     +     %include temp;
52623     +     filename temp;
52624     +     %score1(ExportedCompChanged=&_exportedCompChanged, HideVariableChanged=&_hideVariableChanged);
52625     +%end;
52626     +%if (&_trainnum = 2 ) or %upcase(&EM_PROPERTY_TWOSTAGECLUS) = YES %then %do;
52627     +     filename temp catalog 'sashelp.emexpl.variableclustering_score2.source';
52628     +     %include temp;
52629     +     filename temp;
52630     +     %score2(ExportedCompChanged=&_exportedCompChanged, HideVariableChanged=&_hideVariableChanged);
52631     +%end;
52633     +  /* store  current property values */
52634     + data &EM_USER_VARCLUSMETA;
52635     +       set &EM_USER_VARCLUSMETA;
52636     +        ExportedComp = "&EM_PROPERTY_EXPORTEDCOMP";
52637     +        HideVariable = "&EM_PROPERTY_HIDEVARIABLE";
52638     + run;
52640     +%mend score;
NOTE: %INCLUDE (level 1) ending.
MPRINT(MAIN):   filename temp;
NOTE: Fileref TEMP has been deassigned.
MPRINT(SCORE):   filename temp catalog 'sashelp.emexpl.variableclustering_score_macros.source';
NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMEXPL.VARIABLECLUSTERING_SCORE_MACROS.SOURCE.
52644     +%macro ChangeVariableSelectionFlag(Indata=, gcluster=);
52645     +     proc sort data =&indata;
52646     +              by Cluster RsqRatio Type;
52647     +     run;
52648     +     /*----------------------------------------------------------------------
52649     +      The Type variabe is used becuse the variable need to be selected
52650     +        instead of Cluster component when only one variable is in the cluster
52651     +     +-----------------------------------------------------------------------*/
52653     +     %if &EM_PROPERTY_EXPORTEDCOMP eq CLUSTERCOMP %then %do;
52654     +         data &indata;
52655     +              set &indata; by cluster;
52656     +              if first.Cluster then Selected = 'YES';
52657     +              else Selected = 'NO';
52658     +         run;
52659     +         quit;
52660     +    %end;
52661     +    %else %do;
52662     +         data &indata(drop = _var _varchange);
52663     +              set &indata; retain _var 0; by Cluster;
52664     +             if first.Cluster then  _varchange = 0;
52665     +                 else _varchange =1;
52666     +             if _var ne _varchange then  Selected  = 'YES';
52667     +             else Selected = 'NO';
52668     +             if last.cluster then  _var = 0;
52669     +             else _var = _varchange;
52670     +         run;
52671     +         quit;
52672     +    %end;
52673     +%mend ChangeVariableSelectionFlag;
NOTE: %INCLUDE (level 1) ending.
MPRINT(SCORE):   filename temp;
NOTE: Fileref TEMP has been deassigned.
MPRINT(SCORE):   ;
MPRINT(SCORE):   data _null_;
MPRINT(SCORE):   set EMWS8.VarClus_VARCLUSMETA;
MPRINT(SCORE):   if _N_=1 then call symput('_trainnum', TrainNum);
MPRINT(SCORE):   call symput('_exportedcomp', ExportedComp);
MPRINT(SCORE):   call symput('_hidevariable', HideVariable);
MPRINT(SCORE):   call symput('_newTrain', NewTrain);
MPRINT(SCORE):   run;

NOTE: Numeric values have been converted to character values at the places given by: (Line):(Column).
      30:26   
NOTE: There were 1 observations read from the data set EMWS8.VARCLUS_VARCLUSMETA.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
      

MPRINT(SCORE):   filename temp catalog 'sashelp.emexpl.variableclustering_score1.source';
NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMEXPL.VARIABLECLUSTERING_SCORE1.SOURCE.
52676     +%macro score1(ExportedCompChanged=,
52677     +              HideVariableChanged=);
52679     +   %EM_GETNAME(KEY=OUTRSQUARE, TYPE=DATA);
52680     +   %if &ExportedCompChanged = Y %then %do;
52681     +   %ChangeVariableSelectionFlag(Indata=&EM_USER_OUTRSQUARE);
52682     +   %end;
52683     +   %MakeDeltaCode(groupds=&EM_USER_OUTRSQUARE, DeltaCodeFile=&EM_FILE_CDELTA_TRAIN);
52685     +%mend score1;
NOTE: %INCLUDE (level 1) ending.
MPRINT(SCORE):   filename temp;
NOTE: Fileref TEMP has been deassigned.
MPRINT(SCORE1):  ;
MPRINT(CHANGEVARIABLESELECTIONFLAG):   proc sort data =EMWS8.VarClus_OUTRSQUARE;
MPRINT(CHANGEVARIABLESELECTIONFLAG):   by Cluster RsqRatio Type;
MPRINT(CHANGEVARIABLESELECTIONFLAG):   run;

NOTE: There were 32 observations read from the data set EMWS8.VARCLUS_OUTRSQUARE.
NOTE: The data set EMWS8.VARCLUS_OUTRSQUARE has 32 observations and 9 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.00 seconds
      cpu time            0.01 seconds
      

MPRINT(CHANGEVARIABLESELECTIONFLAG):   data EMWS8.VarClus_OUTRSQUARE;
MPRINT(CHANGEVARIABLESELECTIONFLAG):   set EMWS8.VarClus_OUTRSQUARE;
MPRINT(CHANGEVARIABLESELECTIONFLAG):   by cluster;
MPRINT(CHANGEVARIABLESELECTIONFLAG):   if first.Cluster then Selected = 'YES';
MPRINT(CHANGEVARIABLESELECTIONFLAG):   else Selected = 'NO';
MPRINT(CHANGEVARIABLESELECTIONFLAG):   run;

NOTE: There were 32 observations read from the data set EMWS8.VARCLUS_OUTRSQUARE.
NOTE: The data set EMWS8.VARCLUS_OUTRSQUARE has 32 observations and 9 variables.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
      

MPRINT(CHANGEVARIABLESELECTIONFLAG):   quit;
MPRINT(SCORE1):  ;
MPRINT(MAKEDELTACODE):   *--- Build Code to Modify Metadata ---*;
MPRINT(MAKEDELTACODE):   filename X "C:\\predictive-models-project\Workspaces\EMWS8\VarClus\CDELTA_TRAIN.sas";
MPRINT(MAKEDELTACODE):   data _null_;
MPRINT(MAKEDELTACODE):   FILE X;
MPRINT(MAKEDELTACODE):   set EMWS8.VarClus_OUTRSQUARE end=eof;
MPRINT(MAKEDELTACODE):   if _N_=1 then do;
MPRINT(MAKEDELTACODE):   put "if upcase(strip(ROLE))='INPUT' and upcase(strip(LEVEL))='INTERVAL' then do;";
MPRINT(MAKEDELTACODE):   put "if upcase(strip(NAME)) in (";
MPRINT(MAKEDELTACODE):   end;
MPRINT(MAKEDELTACODE):   if Strip(upcase(Selected)) eq 'YES' then do;
MPRINT(MAKEDELTACODE):   string = '"'!!trim(left(VARIABLE))!!'"';
MPRINT(MAKEDELTACODE):   put string;
MPRINT(MAKEDELTACODE):   end;
MPRINT(MAKEDELTACODE):   if eof then do;
MPRINT(MAKEDELTACODE):   put ') then ROLE="INPUT";';
MPRINT(MAKEDELTACODE):   put 'else ROLE="REJECTED";';
MPRINT(MAKEDELTACODE):   put 'end;';
MPRINT(MAKEDELTACODE):   put 'if upcase(strip(ROLE)) = "REJECTED" then delete ;';
MPRINT(MAKEDELTACODE):   end;
MPRINT(MAKEDELTACODE):   run;

NOTE: The file X is:
      Filename=C:\\predictive-models-project\Workspaces\EMWS8\VarClus\CDELTA_TRAIN.sas,
      RECFM=V,LRECL=256,File Size (bytes)=0,
      Last Modified=16. April 2016 18.29 Uhr,
      Create Time=03. April 2016 17.12 Uhr

NOTE: 14 records were written to the file X.
      The minimum record length was 4.
      The maximum record length was 75.
NOTE: There were 32 observations read from the data set EMWS8.VARCLUS_OUTRSQUARE.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
      

MPRINT(MAKEDELTACODE):   quit;
MPRINT(MAKEDELTACODE):   filename X;
NOTE: Fileref X has been deassigned.
MPRINT(MAKEDELTACODE):   quit;
MPRINT(SCORE1):  ;
MPRINT(SCORE):  ;
MPRINT(SCORE):   data EMWS8.VarClus_VARCLUSMETA;
MPRINT(SCORE):   set EMWS8.VarClus_VARCLUSMETA;
MPRINT(SCORE):   ExportedComp = "CLUSTERCOMP";
MPRINT(SCORE):   HideVariable = "Y";
MPRINT(SCORE):   run;

NOTE: There were 1 observations read from the data set EMWS8.VARCLUS_VARCLUSMETA.
NOTE: The data set EMWS8.VARCLUS_VARCLUSMETA has 1 observations and 5 variables.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.01 seconds
      

MPRINT(MAIN):  ;
MPRINT(EM_DIAGRAM):  ;
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):   * End SCORE: VarClus;
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;
52687      
52688      *------------------------------------------------------------*;
52689      * End SCORE: VarClus;
52690      *------------------------------------------------------------*;

52691      filename emflow "C:\\predictive-models-project\Workspaces\EMWS8\VarClus\EMFLOWSCORE.sas";
MPRINT(EM_DIAGRAM):    filename emflow "C:\\predictive-models-project\Workspaces\EMWS8\VarClus\EMFLOWSCORE.sas";
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):   * VarClus: Scoring DATA data;
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;
52692      *------------------------------------------------------------*;
52693      * VarClus: Scoring DATA data;
52694      *------------------------------------------------------------*;
52695      data EMWS8.VarClus_TRAIN
52696      / view=EMWS8.VarClus_TRAIN
52697      ;
MPRINT(EM_DIAGRAM):   data EMWS8.VarClus_TRAIN / view=EMWS8.VarClus_TRAIN ;
52698      set EMWS8.Part_TRAIN
52699      ;
MPRINT(EM_DIAGRAM):   set EMWS8.Part_TRAIN ;
52700      %inc emflow;
NOTE: %INCLUDE (level 1) file EMFLOW is file C:\\predictive-models-project\Workspaces\EMWS8\VarClus\EMFLOWSCORE.sas.
52701     +
52702     +/*-------------------------------------------------*/
52703     +/* Varclus Score Code Begins*/
52704     +/*-------------------------------------------------*/
52705     +
52706     +Clus1 = 0 ; /*---Cluster Component 1------ */
MPRINT(EM_DIAGRAM):   Clus1 = 0 ;
52707     +Clus2 = 0 ; /*---Cluster Component 2------ */
MPRINT(EM_DIAGRAM):   Clus2 = 0 ;
52708     +Clus3 = 0 ; /*---Cluster Component 3------ */
MPRINT(EM_DIAGRAM):   Clus3 = 0 ;
52709     +Clus4 = 0 ; /*---Cluster Component 4------ */
MPRINT(EM_DIAGRAM):   Clus4 = 0 ;
52710     +Clus5 = 0 ; /*---Cluster Component 5------ */
MPRINT(EM_DIAGRAM):   Clus5 = 0 ;
52711     +Clus6 = 0 ; /*---Cluster Component 6------ */
MPRINT(EM_DIAGRAM):   Clus6 = 0 ;
52712     +Clus7 = 0 ; /*---Cluster Component 7------ */
MPRINT(EM_DIAGRAM):   Clus7 = 0 ;
52713     +Clus8 = 0 ; /*---Cluster Component 8------ */
MPRINT(EM_DIAGRAM):   Clus8 = 0 ;
52714     +Clus8 = Clus8+1 * (AcceptedCmpTotal - 0.31255265374894)/0.66837726102124;
MPRINT(EM_DIAGRAM):   Clus8 = Clus8+1 * (AcceptedCmpTotal - 0.31255265374894)/0.66837726102124;
52715     +Clus2 = Clus2+0.5 * (Age - 47.2059814658803)/12.0632948493559;
MPRINT(EM_DIAGRAM):   Clus2 = Clus2+0.5 * (Age - 47.2059814658803)/12.0632948493559;
52716     +Clus4 = Clus4+0.19973986384379 * (Frq - 12.6545914069081)/7.1598086029145;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.19973986384379 * (Frq - 12.6545914069081)/7.1598086029145;
52717     +Clus1 = Clus1+0.15242317288807 * (Income - 51962.545914069)/20878.2658128313;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.15242317288807 * (Income - 51962.545914069)/20878.2658128313;
52718     +Clus1 = Clus1+-0.11326525887946 * (Kidhome - 0.43555181128896)/0.53438033047728;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+-0.11326525887946 * (Kidhome - 0.43555181128896)/0.53438033047728;
52719     +Clus1 = Clus1+0.16405768583044 * (Mnt - 615.68197135636)/604.537497355942;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.16405768583044 * (Mnt - 615.68197135636)/604.537497355942;
52720     +Clus1 = Clus1+0.12820704015091 * (MntFishProducts - 36.4945240101095)/52.2208809602509;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.12820704015091 * (MntFishProducts - 36.4945240101095)/52.2208809602509;
52721     +Clus1 = Clus1+0.13003723528825 * (MntFruits - 27.153748946925)/39.7289323595324;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.13003723528825 * (MntFruits - 27.153748946925)/39.7289323595324;
52722     +Clus4 = Clus4+0.12026967394981 * (MntGoldProds - 44.0589721988205)/51.1646481009475;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.12026967394981 * (MntGoldProds - 44.0589721988205)/51.1646481009475;
52723     +Clus1 = Clus1+0.15378172897501 * (MntMeatProducts - 169.965037910699)/216.176716057929;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.15378172897501 * (MntMeatProducts - 169.965037910699)/216.176716057929;
52724     +Clus1 = Clus1+0.12839407773078 * (MntSweetProducts - 27.0804549283909)/39.2356363442449;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.12839407773078 * (MntSweetProducts - 27.0804549283909)/39.2356363442449;
52725     +Clus4 = Clus4+0.16875412248328 * (MntWines - 310.929233361415)/341.695699656276;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.16875412248328 * (MntWines - 310.929233361415)/341.695699656276;
52726     +Clus3 = Clus3+1 * (MonthsAsCustomer - 83.24599831508)/16.9420859404964;
MPRINT(EM_DIAGRAM):   Clus3 = Clus3+1 * (MonthsAsCustomer - 83.24599831508)/16.9420859404964;
52727     +Clus4 = Clus4+0.17191033798819 * (NumCatalogPurchases - 2.64448188711036)/2.77214051734809;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.17191033798819 * (NumCatalogPurchases - 2.64448188711036)/2.77214051734809;
52728     +Clus5 = Clus5+0.59365846567538 * (NumDealsPurchases - 2.25526537489469)/1.67318269219337;
MPRINT(EM_DIAGRAM):   Clus5 = Clus5+0.59365846567538 * (NumDealsPurchases - 2.25526537489469)/1.67318269219337;
52729     +Clus4 = Clus4+0.19568478317119 * (NumDistPurchases - 6.73504633529907)/4.60209117827878;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.19568478317119 * (NumDistPurchases - 6.73504633529907)/4.60209117827878;
52730     +Clus4 = Clus4+0.16265391840825 * (NumStorePurchases - 5.91954507160909)/3.25562388118508;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.16265391840825 * (NumStorePurchases - 5.91954507160909)/3.25562388118508;
52731     +Clus4 = Clus4+0.16220922357079 * (NumWebPurchases - 4.09056444818871)/2.61390561975288;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.16220922357079 * (NumWebPurchases - 4.09056444818871)/2.61390561975288;
52732     +Clus1 = Clus1+-0.12106102877754 * (NumWebVisitsMonth - 5.24220724515585)/2.33225525940929;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+-0.12106102877754 * (NumWebVisitsMonth - 5.24220724515585)/2.33225525940929;
52733     +Clus7 = Clus7+1 * (RFMstat - 531.396946202506)/1565.49314871989;
MPRINT(EM_DIAGRAM):   Clus7 = Clus7+1 * (RFMstat - 531.396946202506)/1565.49314871989;
52734     +Clus1 = Clus1+0.15685430945271 * (RMntFrq - 37.80392418146)/30.0642993170191;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.15685430945271 * (RMntFrq - 37.80392418146)/30.0642993170191;
52735     +Clus6 = Clus6+1 * (Recency - 48.7742207245156)/28.8224799181808;
MPRINT(EM_DIAGRAM):   Clus6 = Clus6+1 * (Recency - 48.7742207245156)/28.8224799181808;
52736     +Clus5 = Clus5+0.59365846567538 * (Teenhome - 0.48652064026958)/0.55047336656954;
MPRINT(EM_DIAGRAM):   Clus5 = Clus5+0.59365846567538 * (Teenhome - 0.48652064026958)/0.55047336656954;
52737     +Clus2 = Clus2+-0.5 * (Year_Birth - 1968.79401853412)/12.0632948493559;
MPRINT(EM_DIAGRAM):   Clus2 = Clus2+-0.5 * (Year_Birth - 1968.79401853412)/12.0632948493559;
NOTE: %INCLUDE (level 1) ending.
MPRINT(EM_DIAGRAM):   run;
52738      run;

NOTE: DATA STEP view saved on file EMWS8.VARCLUS_TRAIN.
NOTE: A stored DATA STEP view cannot run under a different operating system.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
      

MPRINT(EM_DIAGRAM):   quit;
52739      quit;
52740      filename emflow;
MPRINT(EM_DIAGRAM):   filename emflow;
NOTE: Fileref EMFLOW has been deassigned.
52741      filename emflow "C:\\predictive-models-project\Workspaces\EMWS8\VarClus\EMFLOWSCORE.sas";
MPRINT(EM_DIAGRAM):    filename emflow "C:\\predictive-models-project\Workspaces\EMWS8\VarClus\EMFLOWSCORE.sas";
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):   * VarClus: Scoring VALIDATE data;
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;
52742      *------------------------------------------------------------*;
52743      * VarClus: Scoring VALIDATE data;
52744      *------------------------------------------------------------*;
52745      data EMWS8.VarClus_VALIDATE
52746      / view=EMWS8.VarClus_VALIDATE
52747      ;
MPRINT(EM_DIAGRAM):   data EMWS8.VarClus_VALIDATE / view=EMWS8.VarClus_VALIDATE ;
52748      set EMWS8.Part_VALIDATE
52749      ;
MPRINT(EM_DIAGRAM):   set EMWS8.Part_VALIDATE ;
52750      %inc emflow;
NOTE: %INCLUDE (level 1) file EMFLOW is file C:\\predictive-models-project\Workspaces\EMWS8\VarClus\EMFLOWSCORE.sas.
52751     +
52752     +/*-------------------------------------------------*/
52753     +/* Varclus Score Code Begins*/
52754     +/*-------------------------------------------------*/
52755     +
52756     +Clus1 = 0 ; /*---Cluster Component 1------ */
MPRINT(EM_DIAGRAM):   Clus1 = 0 ;
52757     +Clus2 = 0 ; /*---Cluster Component 2------ */
MPRINT(EM_DIAGRAM):   Clus2 = 0 ;
52758     +Clus3 = 0 ; /*---Cluster Component 3------ */
MPRINT(EM_DIAGRAM):   Clus3 = 0 ;
52759     +Clus4 = 0 ; /*---Cluster Component 4------ */
MPRINT(EM_DIAGRAM):   Clus4 = 0 ;
52760     +Clus5 = 0 ; /*---Cluster Component 5------ */
MPRINT(EM_DIAGRAM):   Clus5 = 0 ;
52761     +Clus6 = 0 ; /*---Cluster Component 6------ */
MPRINT(EM_DIAGRAM):   Clus6 = 0 ;
52762     +Clus7 = 0 ; /*---Cluster Component 7------ */
MPRINT(EM_DIAGRAM):   Clus7 = 0 ;
52763     +Clus8 = 0 ; /*---Cluster Component 8------ */
MPRINT(EM_DIAGRAM):   Clus8 = 0 ;
52764     +Clus8 = Clus8+1 * (AcceptedCmpTotal - 0.31255265374894)/0.66837726102124;
MPRINT(EM_DIAGRAM):   Clus8 = Clus8+1 * (AcceptedCmpTotal - 0.31255265374894)/0.66837726102124;
52765     +Clus2 = Clus2+0.5 * (Age - 47.2059814658803)/12.0632948493559;
MPRINT(EM_DIAGRAM):   Clus2 = Clus2+0.5 * (Age - 47.2059814658803)/12.0632948493559;
52766     +Clus4 = Clus4+0.19973986384379 * (Frq - 12.6545914069081)/7.1598086029145;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.19973986384379 * (Frq - 12.6545914069081)/7.1598086029145;
52767     +Clus1 = Clus1+0.15242317288807 * (Income - 51962.545914069)/20878.2658128313;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.15242317288807 * (Income - 51962.545914069)/20878.2658128313;
52768     +Clus1 = Clus1+-0.11326525887946 * (Kidhome - 0.43555181128896)/0.53438033047728;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+-0.11326525887946 * (Kidhome - 0.43555181128896)/0.53438033047728;
52769     +Clus1 = Clus1+0.16405768583044 * (Mnt - 615.68197135636)/604.537497355942;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.16405768583044 * (Mnt - 615.68197135636)/604.537497355942;
52770     +Clus1 = Clus1+0.12820704015091 * (MntFishProducts - 36.4945240101095)/52.2208809602509;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.12820704015091 * (MntFishProducts - 36.4945240101095)/52.2208809602509;
52771     +Clus1 = Clus1+0.13003723528825 * (MntFruits - 27.153748946925)/39.7289323595324;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.13003723528825 * (MntFruits - 27.153748946925)/39.7289323595324;
52772     +Clus4 = Clus4+0.12026967394981 * (MntGoldProds - 44.0589721988205)/51.1646481009475;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.12026967394981 * (MntGoldProds - 44.0589721988205)/51.1646481009475;
52773     +Clus1 = Clus1+0.15378172897501 * (MntMeatProducts - 169.965037910699)/216.176716057929;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.15378172897501 * (MntMeatProducts - 169.965037910699)/216.176716057929;
52774     +Clus1 = Clus1+0.12839407773078 * (MntSweetProducts - 27.0804549283909)/39.2356363442449;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.12839407773078 * (MntSweetProducts - 27.0804549283909)/39.2356363442449;
52775     +Clus4 = Clus4+0.16875412248328 * (MntWines - 310.929233361415)/341.695699656276;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.16875412248328 * (MntWines - 310.929233361415)/341.695699656276;
52776     +Clus3 = Clus3+1 * (MonthsAsCustomer - 83.24599831508)/16.9420859404964;
MPRINT(EM_DIAGRAM):   Clus3 = Clus3+1 * (MonthsAsCustomer - 83.24599831508)/16.9420859404964;
52777     +Clus4 = Clus4+0.17191033798819 * (NumCatalogPurchases - 2.64448188711036)/2.77214051734809;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.17191033798819 * (NumCatalogPurchases - 2.64448188711036)/2.77214051734809;
52778     +Clus5 = Clus5+0.59365846567538 * (NumDealsPurchases - 2.25526537489469)/1.67318269219337;
MPRINT(EM_DIAGRAM):   Clus5 = Clus5+0.59365846567538 * (NumDealsPurchases - 2.25526537489469)/1.67318269219337;
52779     +Clus4 = Clus4+0.19568478317119 * (NumDistPurchases - 6.73504633529907)/4.60209117827878;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.19568478317119 * (NumDistPurchases - 6.73504633529907)/4.60209117827878;
52780     +Clus4 = Clus4+0.16265391840825 * (NumStorePurchases - 5.91954507160909)/3.25562388118508;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.16265391840825 * (NumStorePurchases - 5.91954507160909)/3.25562388118508;
52781     +Clus4 = Clus4+0.16220922357079 * (NumWebPurchases - 4.09056444818871)/2.61390561975288;
MPRINT(EM_DIAGRAM):   Clus4 = Clus4+0.16220922357079 * (NumWebPurchases - 4.09056444818871)/2.61390561975288;
52782     +Clus1 = Clus1+-0.12106102877754 * (NumWebVisitsMonth - 5.24220724515585)/2.33225525940929;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+-0.12106102877754 * (NumWebVisitsMonth - 5.24220724515585)/2.33225525940929;
52783     +Clus7 = Clus7+1 * (RFMstat - 531.396946202506)/1565.49314871989;
MPRINT(EM_DIAGRAM):   Clus7 = Clus7+1 * (RFMstat - 531.396946202506)/1565.49314871989;
52784     +Clus1 = Clus1+0.15685430945271 * (RMntFrq - 37.80392418146)/30.0642993170191;
MPRINT(EM_DIAGRAM):   Clus1 = Clus1+0.15685430945271 * (RMntFrq - 37.80392418146)/30.0642993170191;
52785     +Clus6 = Clus6+1 * (Recency - 48.7742207245156)/28.8224799181808;
MPRINT(EM_DIAGRAM):   Clus6 = Clus6+1 * (Recency - 48.7742207245156)/28.8224799181808;
52786     +Clus5 = Clus5+0.59365846567538 * (Teenhome - 0.48652064026958)/0.55047336656954;
MPRINT(EM_DIAGRAM):   Clus5 = Clus5+0.59365846567538 * (Teenhome - 0.48652064026958)/0.55047336656954;
52787     +Clus2 = Clus2+-0.5 * (Year_Birth - 1968.79401853412)/12.0632948493559;
MPRINT(EM_DIAGRAM):   Clus2 = Clus2+-0.5 * (Year_Birth - 1968.79401853412)/12.0632948493559;
NOTE: %INCLUDE (level 1) ending.
MPRINT(EM_DIAGRAM):   run;
52788      run;

NOTE: DATA STEP view saved on file EMWS8.VARCLUS_VALIDATE.
NOTE: A stored DATA STEP view cannot run under a different operating system.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
      

MPRINT(EM_DIAGRAM):   quit;
52789      quit;
52790      filename emflow;
MPRINT(EM_DIAGRAM):   filename emflow;
NOTE: Fileref EMFLOW has been deassigned.
52792      *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):     *------------------------------------------------------------*;
52793      * VarClus: Computing metadata for TRAIN data;
MPRINT(EM_DIAGRAM):   * VarClus: Computing metadata for TRAIN data;
52794      *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;

NOTE: View EMWS8.VARCLUS_TRAIN.VIEW used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
      
MPRINT(EM_DIAGRAM):    *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):   * &nodeid: Computing Metadata for TRAIN data;
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):   filename _delta "C:\\predictive-models-project\Workspaces\EMWS8\VarClus\CDELTA_TRAIN.sas";
MPRINT(EMADVISECOLUMNS):   proc display c=sashelp.emmeta.advisecolumns.scl;
MPRINT(EMADVISECOLUMNS):   run;
MPRINT(EMADVISECOLUMNS):    options validvarname=any;
MPRINT(EMADVISECOLUMNS):   proc contents data=EMWS8.VarClus_TRAIN out=_tempAdvisor noprint;
MPRINT(EMADVISECOLUMNS):   run;
MPRINT(EMADVISECOLUMNS):   options validvarname=V7;
MPRINT(EMADVISECOLUMNS):    data _null_;
MPRINT(EMADVISECOLUMNS):   dsid = open('EMWS8.VarClus_TRAIN');
MPRINT(EMADVISECOLUMNS):   call symput('_dsidTable', strip(put(dsid, best.)));
MPRINT(EMADVISECOLUMNS):   if dsid then do;
MPRINT(EMADVISECOLUMNS):   call symput('_engineTable', attrc(dsid, 'ENGINE'));
MPRINT(EMADVISECOLUMNS):   dsid = close(dsid);
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   run;
MPRINT(EMADVISECOLUMNS):    proc contents data=EMWS8.VarClus_TRAIN out=WORK.M26O0QAJ noprint;
MPRINT(EMADVISECOLUMNS):   run;
MPRINT(EMADVISECOLUMNS):    data WORK.M26O0QAJ;
MPRINT(EMADVISECOLUMNS):   length NAME $ 64 TYPE $ 1 LABEL $ 200 FORMAT $ 20 INFORMAT $20 INDEX $ 1 INDEXTYPE $ 9;
MPRINT(EMADVISECOLUMNS):   label NAME =;
MPRINT(EMADVISECOLUMNS):   set WORK.M26O0QAJ(keep=name type length label format formatl formatd informat informl informd idxusage rename=(type=itype));
MPRINT(EMADVISECOLUMNS):   if itype = 1 then type = 'N';
MPRINT(EMADVISECOLUMNS):   else type = 'C';
MPRINT(EMADVISECOLUMNS):   if formatl > 0 then do;
MPRINT(EMADVISECOLUMNS):   if format ne ' ' then format = strip(format)!!strip(put(formatl, best12.))!!'.'!!strip(put(formatd, best12.));
MPRINT(EMADVISECOLUMNS):   else format = strip(put(formatl, best12.))!!'.'!!strip(put(formatd, best12.));
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   else if format ne '' then format = strip(format)!!'.';
MPRINT(EMADVISECOLUMNS):   if informl > 0 then do;
MPRINT(EMADVISECOLUMNS):   if informat ne ' ' then informat = strip(informat)!!strip(put(informl, best12.))!!'.'!!strip(put(informd, best12.));
MPRINT(EMADVISECOLUMNS):   else informat = strip(put(informl, best12.))!!'.'!!strip(put(informd, best12.));
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   else if informat ne '' then informat = strip(informat)!!'.';
MPRINT(EMADVISECOLUMNS):   if idxusage = 'NONE' then index ="N";
MPRINT(EMADVISECOLUMNS):   else index = "Y";
MPRINT(EMADVISECOLUMNS):   indextype = idxusage;
MPRINT(EMADVISECOLUMNS):   drop idxusage itype formatl formatd informl informd;
MPRINT(EMADVISECOLUMNS):   run;
MPRINT(EMADVISECOLUMNS):    data WORK.M26O0QAJ;
MPRINT(EMADVISECOLUMNS):   length UNAME $64;
MPRINT(EMADVISECOLUMNS):   set WORK.M26O0QAJ;
MPRINT(EMADVISECOLUMNS):   UNAME = upcase(NAME);
MPRINT(EMADVISECOLUMNS):   run;
MPRINT(EMADVISECOLUMNS):    proc sort data=WORK.M1T9SQ23 NOTHREADS;
MPRINT(EMADVISECOLUMNS):   by UNAME;
MPRINT(EMADVISECOLUMNS):   run;
MPRINT(EMADVISECOLUMNS):    data WORK.M1T9SQ23;
MPRINT(EMADVISECOLUMNS):   drop UNAME;
MPRINT(EMADVISECOLUMNS):   set WORK.M1T9SQ23;
MPRINT(EMADVISECOLUMNS):   run;
MPRINT(EMADVISECOLUMNS):    data WORK.M34I00S0(keep=NAME ATTR);
MPRINT(EMADVISECOLUMNS):   length ATTR $ 20;
MPRINT(EMADVISECOLUMNS):   set WORK.M1T9SQ23;
MPRINT(EMADVISECOLUMNS):   if level ne "INTERVAL" then do;
MPRINT(EMADVISECOLUMNS):   if order = ' ' then do;
MPRINT(EMADVISECOLUMNS):   attr = 'ORDER';
MPRINT(EMADVISECOLUMNS):   output;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   if format ne ' ' and formattype = ' ' then do;
MPRINT(EMADVISECOLUMNS):   attr = 'FORMATTYPE';
MPRINT(EMADVISECOLUMNS):   output;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   if role = ' ' then do;
MPRINT(EMADVISECOLUMNS):   attr = 'ROLE';
MPRINT(EMADVISECOLUMNS):   output;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   if level = ' ' then do;
MPRINT(EMADVISECOLUMNS):   attr = 'LEVEL';
MPRINT(EMADVISECOLUMNS):   output;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   if type = ' ' then do;
MPRINT(EMADVISECOLUMNS):   attr = 'TYPE';
MPRINT(EMADVISECOLUMNS):   output;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   if index = ' ' then do;
MPRINT(EMADVISECOLUMNS):   attr = 'INDEX';
MPRINT(EMADVISECOLUMNS):   output;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   if report = ' ' then do;
MPRINT(EMADVISECOLUMNS):   attr = 'REPORT';
MPRINT(EMADVISECOLUMNS):   output;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   run;
MPRINT(EMADVISECOLUMNS):   proc sort NOTHREADS;
MPRINT(EMADVISECOLUMNS):   by attr;
MPRINT(EMADVISECOLUMNS):   run;
MPRINT(EMADVISECOLUMNS):    data WORK.M1T9SQ23;
MPRINT(EMADVISECOLUMNS):   length NAME $64 ROLE $ 32 LEVEL $ 10 ORDER $ 8 CREATOR $32 FORMATTYPE $ 10 FAMILY $ 10 LOWERLIMIT 8 UPPERLIMIT 8 REPORT $1 DISTRIBUTION $ 20 COMMENT $64;
MPRINT(EMADVISECOLUMNS):   length levelAssigned 8 roleAssigned 8 PRICE 8;
MPRINT(EMADVISECOLUMNS):   set WORK.M1T9SQ23;
MPRINT(EMADVISECOLUMNS):   if formattype = ' ' then do;
MPRINT(EMADVISECOLUMNS):   if format ne ' ' then do;
MPRINT(EMADVISECOLUMNS):   if type = 'N' then do;
MPRINT(EMADVISECOLUMNS):   pos = indexc(format,'.1234567890');
MPRINT(EMADVISECOLUMNS):   if pos > 1 then tempfmt = substr(format,1, pos-1);
MPRINT(EMADVISECOLUMNS):   else tempfmt = ' ';
MPRINT(EMADVISECOLUMNS):   flen = length(tempfmt);
MPRINT(EMADVISECOLUMNS):   select;
MPRINT(EMADVISECOLUMNS):   when(tempfmt in ("DATE" "DAY" "DDMMYY" "DOWNAME" "JULDAY" "JULIAN" "MMDDYY" "MMDDYYD" "MMDDYYC" "MMDDYYN" "MMDDYYP" "MMDDYYS" "MONNAME" "MONTH" "MONYY" "NENGO" "QTR" "QTRR" "WEEKDATE" "WEEKDATX" "WEEKDAY" "WORDDATE" "WORDDATX" 
"YEAR" "YYMMDD" "YYMON" "YYMMDDC" "YYMMDDD" "YYMMDDN" "YYMMDDP" "YYMMDDS" "EURDFDE" "NJDATE" "NLDATE" "EURDFDD" "EURDFDWN" "EURDFMN" "EURDFMY" "EURDFWK" "EURDFWKX" "EURDFWDX" "EURDFDN" "EURDFDE" )) formattype = 'DATE';
MPRINT(EMADVISECOLUMNS):   when(tempfmt in ("DATETIME" "EURDFDT" "TOD" )) formattype = "DATETIME";
MPRINT(EMADVISECOLUMNS):   when(tempfmt in ("HHMM" "HOUR" "MMSS" "TIME" "TIMEAMPM" )) formattype = "TIME";
MPRINT(EMADVISECOLUMNS):   when(tempfmt in ("COMMA" "COMMAX" "DOLLAR" "DOLLARX" "E" "FRACT" "NEGPAREN" "PERCENT")) formattype="QUANTITY";
MPRINT(EMADVISECOLUMNS):   when(tempfmt in ("BINARY" "HEX" "IB" "OCTAL" "PD" "PIB" "PK" "RB" "SSN" "Z" "ZD")) formattype = "CODING";
MPRINT(EMADVISECOLUMNS):   otherwise do;
MPRINT(EMADVISECOLUMNS):   formattype = "USER";
MPRINT(EMADVISECOLUMNS):   if substr(tempfmt, 1, 6)='NLDATE' then formattype = "DATE";
MPRINT(EMADVISECOLUMNS):   else if substr(tempfmt, 1, 6)='NLDATM' then formattype = "DATETIME";
MPRINT(EMADVISECOLUMNS):   else if substr(tempfmt, 1, 4)='NLTIM' then formattype = "TIME";
MPRINT(EMADVISECOLUMNS):   else if flen >= 4 then do;
MPRINT(EMADVISECOLUMNS):   str = substr(tempfmt,1,4);
MPRINT(EMADVISECOLUMNS):   if str in ("MMYY" "YYMM" "YYQR") then formattype ="DATE";
MPRINT(EMADVISECOLUMNS):   else if str = "S370" then formattype = "CODING";
MPRINT(EMADVISECOLUMNS):   else if str = "BEST" then formattype = "NUM";
MPRINT(EMADVISECOLUMNS):   drop str;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   else if flen >=3 and substr(tempfmt,1,3) = "YYQ" then formatType = "DATE";
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   drop flen tempfmt pos;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   else do;
MPRINT(EMADVISECOLUMNS):   formatType = "CATEGORY";
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   if formatType = "NUM" then do;
MPRINT(EMADVISECOLUMNS):   if index = "Y" then formatType = "DISCRETE";
MPRINT(EMADVISECOLUMNS):   else formatType = "QUANTITY";
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   if level = ' ' then do;
MPRINT(EMADVISECOLUMNS):   if formatType in ("CATEGORY", "CODING", "ID") or type = "C" then level = "NOMINAL";
MPRINT(EMADVISECOLUMNS):   else level = "INTERVAL";
MPRINT(EMADVISECOLUMNS):   levelAssigned = 1;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   else level = upcase(level);
MPRINT(EMADVISECOLUMNS):   if role = ' ' then do;
MPRINT(EMADVISECOLUMNS):   length name_prefix $8 _uname $64;
MPRINT(EMADVISECOLUMNS):   drop name_prefix _uname _freqflag;
MPRINT(EMADVISECOLUMNS):   retain _freqflag;
MPRINT(EMADVISECOLUMNS):   if LENGTH> 80 then ROLE = 'TEXT';
MPRINT(EMADVISECOLUMNS):   _uname = upcase(NAME);
MPRINT(EMADVISECOLUMNS):   select(_uname);
MPRINT(EMADVISECOLUMNS):   when('_WARN_') ROLE = 'ASSESS';
MPRINT(EMADVISECOLUMNS):   when('EM_SEGMENT') do;
MPRINT(EMADVISECOLUMNS):   ROLE = 'SEGMENT';
MPRINT(EMADVISECOLUMNS):   LEVEL = 'NOMINAL';
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   when('_NODE_') do;
MPRINT(EMADVISECOLUMNS):   ROLE = 'SEGMENT';
MPRINT(EMADVISECOLUMNS):   LEVEL = 'NOMINAL';
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   when('EM_CLASSTARGET') ROLE = 'ASSESS';
MPRINT(EMADVISECOLUMNS):   when('EM_VALUETARGET') ROLE = 'ASSESS';
MPRINT(EMADVISECOLUMNS):   when('EM_PREDICTION') ROLE = 'PREDICT';
MPRINT(EMADVISECOLUMNS):   when('EM_PROBABILITY') ROLE = 'PREDICT';
MPRINT(EMADVISECOLUMNS):   when('EM_EVENTPROBABILITY') ROLE = 'PREDICT';
MPRINT(EMADVISECOLUMNS):   when('EM_CLASSIFICATION') ROLE = 'CLASSIFICATION';
MPRINT(EMADVISECOLUMNS):   when('EM_DECISION') ROLE = 'DECISION';
MPRINT(EMADVISECOLUMNS):   when('EM_PROFIT') ROLE = 'ASSESS';
MPRINT(EMADVISECOLUMNS):   when('EM_LOSS') ROLE = 'ASSESS';
MPRINT(EMADVISECOLUMNS):   when('EM_ROI') ROLE = 'ASSESS';
MPRINT(EMADVISECOLUMNS):   when('URI') ROLE = 'URL';
MPRINT(EMADVISECOLUMNS):   when('FILTERED') ROLE = 'TEXTLOC';
MPRINT(EMADVISECOLUMNS):   otherwise do;
MPRINT(EMADVISECOLUMNS):   if upcase(NAME) =: 'ZIP' then do;
MPRINT(EMADVISECOLUMNS):   ROLE = 'REJECTED';
MPRINT(EMADVISECOLUMNS):   LEVEL = 'NOMINAL';
MPRINT(EMADVISECOLUMNS):   COMMENT = 'Rejected by: Exceed the maximum class level of %s';
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   else if upcase(NAME) in('FREQ', 'FREQUENCY') then do;
MPRINT(EMADVISECOLUMNS):   ROLE = 'FREQ';
MPRINT(EMADVISECOLUMNS):   if TYPE = 'C' then ROLE = 'INPUT';
MPRINT(EMADVISECOLUMNS):   else if _freqflag =1 then ROLE='REJECTED';
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   else do;
MPRINT(EMADVISECOLUMNS):   name_prefix = scan(_uname, 1, '_');
MPRINT(EMADVISECOLUMNS):   if scan(_uname, 2, '_') = '' then name_prefix='';
MPRINT(EMADVISECOLUMNS):   if name_prefix in('F', 'I', 'U') then do;
MPRINT(EMADVISECOLUMNS):   ROLE = 'CLASSIFICATION';
MPRINT(EMADVISECOLUMNS):   LEVEL = 'NOMINAL';
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   else if name_prefix in('P', 'V') then ROLE = 'PREDICT';
MPRINT(EMADVISECOLUMNS):   else if name_prefix in('R', 'RS', 'RT', 'RD', 'RDS', 'RDT', 'RA', 'RAS', 'RAT') then ROLE = 'RESIDUAL';
MPRINT(EMADVISECOLUMNS):   else if name_prefix ='D' then do;
MPRINT(EMADVISECOLUMNS):   ROLE = 'DECISION';
MPRINT(EMADVISECOLUMNS):   LEVEL = 'NOMINAL';
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   else if name_prefix ='B' then do;
MPRINT(EMADVISECOLUMNS):   ROLE = 'SEGMENT';
MPRINT(EMADVISECOLUMNS):   LEVEL = 'NOMINAL';
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   else if name_prefix in('EP', 'BP', 'CP', 'EL', 'CL', 'BL', 'W', 'ROI', 'IC') then ROLE = 'ASSESS';
MPRINT(EMADVISECOLUMNS):   else do;
MPRINT(EMADVISECOLUMNS):   array _ROLE_ (19) $32 _TEMPORARY_ ('ASSESS','CLASSIFICATION','CENSOR', 'COST', 'CROSSID', 'DECISION', 'ID','INPUT', 'LABEL', 'MISSING','PREDICT','REFERRER','REJECTED', 'RESIDUAL','SEGMENT', 'SEQUENCE','TARGET', 'TEXT', 'TIMEID');
MPRINT(EMADVISECOLUMNS):   drop _found_ i;
MPRINT(EMADVISECOLUMNS):   _found_=0;
MPRINT(EMADVISECOLUMNS):   do i=1 to 19 until(_found_=1);
MPRINT(EMADVISECOLUMNS):   if index(_uname, trim(_ROLE_{i}))=1 then do;
MPRINT(EMADVISECOLUMNS):   ROLE=_ROLE_{i};
MPRINT(EMADVISECOLUMNS):   if ROLE = 'ID' then LEVEL = 'NOMINAL';
MPRINT(EMADVISECOLUMNS):   else if ROLE = 'SEGMENT' then LEVEL = 'NOMINAL';
MPRINT(EMADVISECOLUMNS):   else if ROLE = 'TIMEID' and TYPE='N' then LEVEL = 'INTERVAL';
MPRINT(EMADVISECOLUMNS):   _found_=1;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   if length(_uname)>2 then do;
MPRINT(EMADVISECOLUMNS):   if substr(reverse(trim(_uname)), 1, 3) = 'DI_' then do;
MPRINT(EMADVISECOLUMNS):   ROLE = 'ID';
MPRINT(EMADVISECOLUMNS):   LEVEL = 'NOMINAL';
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   if ROLE='FREQ' then _freqflag=1;
MPRINT(EMADVISECOLUMNS):   else if ROLE = 'CLASSIFICATION' then LEVEL = 'NOMINAL';
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   if role = ' ' then do;
MPRINT(EMADVISECOLUMNS):   if formattype in('DATE', 'DATETIME', 'TIME') then role = 'TIMEID';
MPRINT(EMADVISECOLUMNS):   else role = 'INPUT';
MPRINT(EMADVISECOLUMNS):   roleAssigned = 1;
MPRINT(EMADVISECOLUMNS):   end;
MPRINT(EMADVISECOLUMNS):   else role = upcase(role);
MPRINT(EMADVISECOLUMNS):   if REPORT = '' then REPORT = 'N';
MPRINT(EMADVISECOLUMNS):   run;
MPRINT(EMADVISECOLUMNS):    data WORK.M1T9SQ23;
MPRINT(EMADVISECOLUMNS):   set WORK.M1T9SQ23;
MPRINT(EMADVISECOLUMNS):   label NAME = "Variable Name" TYPE = "Type" ROLE = "Role" LEVEL= "Measurement Level" ORDER= "Order" CREATOR= "Creator" FORMATTYPE= "Format Type" FAMILY= "Family" DISTRIBUTION= "Distribution" PRICE= "Price" LOWERLIMIT= "Lower 
limit" UPPERLIMIT= "Upper Limit" REPORT= "Report" COMMENT= "Comment" INDEX= "Index" INDEXTYPE= "IndexType" LABEL= "Label" LENGTH= "Length";
MPRINT(EMADVISECOLUMNS):   drop levelAssigned roleAssigned;
MPRINT(EMADVISECOLUMNS):   run;
MPRINT(EMADVISECOLUMNS):   
MPRINT(EM_DIAGRAM):  ;
MPRINT(EM_DIAGRAM):   proc sort data=WORK.COLUMNMETA;
MPRINT(EM_DIAGRAM):   by NAME;
MPRINT(EM_DIAGRAM):   run;
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):   * &nodeid: Merge incoming metadata;
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):   proc contents data=EMWS8.Part_TRAIN noprint out=_temp2(keep=NAME);
MPRINT(EM_DIAGRAM):   run;
MPRINT(EM_DIAGRAM):   proc sort data=_temp2;
MPRINT(EM_DIAGRAM):   by NAME;
MPRINT(EM_DIAGRAM):   run;
MPRINT(EM_DIAGRAM):   proc sort data=EMWS8.Part_CMeta_TRAIN out=_temp;
MPRINT(EM_DIAGRAM):   by NAME;
MPRINT(EM_DIAGRAM):   run;
MPRINT(EM_DIAGRAM):   data EMWS8.VarClus_CMeta_TRAIN;
MPRINT(EM_DIAGRAM):   merge WORK.COLUMNMETA(in=_a) _temp2(in=_b) _temp(drop=FORMAT INFORMAT LENGTH INDEX INDEXTYPE in=_c) end=_eof_;
MPRINT(EM_DIAGRAM):   by NAME;
MPRINT(EM_DIAGRAM):   if (^_a and _b) or (^_c and _a and _b) then delete;
MPRINT(EM_DIAGRAM):   if ^_b then CREATOR = "VarClus";
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):   * VarClus: Apply Delta Code;
MPRINT(EM_DIAGRAM):   *------------------------------------------------------------*;
MPRINT(EM_DIAGRAM):   if upcase(strip(ROLE))='INPUT' and upcase(strip(LEVEL))='INTERVAL' then do;
MPRINT(EM_DIAGRAM):   if upcase(strip(NAME)) in ( "CLUS1" "CLUS2" "CLUS3" "CLUS4" "CLUS5" "CLUS6" "CLUS7" "CLUS8" ) then ROLE="INPUT";
MPRINT(EM_DIAGRAM):   else ROLE="REJECTED";
MPRINT(EM_DIAGRAM):   end;
MPRINT(EM_DIAGRAM):   if upcase(strip(ROLE)) = "REJECTED" then delete ;
MPRINT(EM_DIAGRAM):   run;
MPRINT(EM_DIAGRAM):   filename _delta;
NOTE: View EMWS8.VARCLUS_TRAIN.VIEW used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
      
NOTE: View EMWS8.VARCLUS_VALIDATE.VIEW used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
      
MPRINT(EM_DIAGRAM):    proc printto;
MPRINT(EM_DIAGRAM):   run;
